<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
<title>OA Expert v4 â€” Plateforme IA Ouvrages d'Art</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%233B82F6'/><text x='16' y='22' text-anchor='middle' fill='white' font-size='16' font-weight='900' font-family='sans-serif'>OA</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
:root{--bg:#0B1120;--sidebar:#0F1729;--card:#141D2F;--card-h:#1A2540;--brd:#1E2A45;--brd-l:#2A3A5C;--pri:#3B82F6;--pri-d:#2563EB;--pri-g:rgba(59,130,246,0.15);--acc:#F59E0B;--acc-g:rgba(245,158,11,0.12);--err:#EF4444;--err-g:rgba(239,68,68,0.12);--ok:#10B981;--ok-g:rgba(16,185,129,0.12);--txt:#E2E8F0;--txt-m:#9DB1D0;--txt-d:#5E7499;--ff:'DM Sans','Segoe UI',sans-serif;--mono:'JetBrains Mono',monospace}
*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden;width:100%}body{font-family:var(--ff);background:var(--bg);color:var(--txt)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238B9DC3' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px!important}
select option{background:var(--card);color:var(--txt)}input:focus,select:focus,textarea:focus{border-color:var(--pri)!important;box-shadow:0 0 0 3px var(--pri-g);outline:none}
button{cursor:pointer;font-family:var(--ff)}a{color:var(--pri);text-decoration:none}textarea{resize:vertical;font-family:var(--ff)}
#app{height:100vh;width:100vw}.app-layout{display:flex;height:100%}
.sidebar{width:256px;min-width:256px;background:var(--sidebar);border-right:1px solid var(--brd);display:flex;flex-direction:column;transition:width .3s,min-width .3s}
.sidebar.collapsed{width:66px;min-width:66px}.sidebar-logo{padding:20px 18px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:12px;cursor:pointer}
.collapsed .sidebar-logo{padding:20px 14px;justify-content:center}
.sidebar-logo-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--pri),var(--acc));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;color:#fff;flex-shrink:0}
.sidebar-logo-text{overflow:hidden;white-space:nowrap}.collapsed .sidebar-logo-text{display:none}
.sidebar-nav{flex:1;padding-top:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 18px;cursor:pointer;font-size:13.5px;color:var(--txt-m);border-left:3px solid transparent;transition:all .2s;white-space:nowrap;overflow:hidden;min-height:36px}
.nav-item:hover{color:var(--txt);background:rgba(255,255,255,0.03)}.nav-item.active{color:var(--pri);background:var(--pri-g);border-left-color:var(--pri);font-weight:600}
.nav-item .nav-icon{flex-shrink:0;width:20px;text-align:center;font-size:16px}.collapsed .nav-item{padding:10px 22px;justify-content:center}.collapsed .nav-item span:not(.nav-icon){display:none}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:14px 28px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;background:var(--sidebar)}
.main-header h1{font-size:18px;font-weight:800}.main-header .sub{font-size:12px;color:var(--txt-m);margin-top:2px}
.main-content{flex:1;overflow:auto;padding:28px}
.card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:20px;margin-bottom:16px}
.card-title{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.stat-num{font-size:28px;font-weight:800;font-family:var(--mono);line-height:1}.stat-label{font-size:11px;color:var(--txt-m);text-transform:uppercase;letter-spacing:1px;margin-top:6px;font-weight:600}.stat-sub{font-size:11px;color:var(--txt-d);margin-top:4px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}th{text-align:left;padding:10px 14px;border-bottom:1px solid var(--brd);color:var(--txt-m);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.8px}td{padding:12px 14px;border-bottom:1px solid var(--brd)}
tr.clickable{cursor:pointer}tr.clickable:hover{background:var(--card-h)}
.fw600{font-weight:600}.fw700{font-weight:700}.fs12{font-size:12px}.fs11{font-size:11px}.fs13{font-size:13px}
.c-m{color:var(--txt-m)}.c-d{color:var(--txt-d)}.c-pri{color:var(--pri)}.c-acc{color:var(--acc)}.c-err{color:var(--err)}.c-ok{color:var(--ok)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;border:none;font-size:13px;font-weight:600;transition:all .2s;min-height:36px}
.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--pri-d)}.btn-acc{background:var(--acc);color:#fff}.btn-err{background:var(--err);color:#fff}
.btn-ghost{background:transparent;color:var(--txt-m);border:1px solid var(--brd)}.btn-ghost:hover{border-color:var(--brd-l);color:var(--txt)}.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px}
.pill{display:inline-flex;align-items:center;padding:5px 14px;border-radius:20px;border:1px solid var(--brd);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--txt-m);min-height:36px}
.pill:hover{border-color:var(--brd-l);color:var(--txt)}.pill.active{border-color:var(--pri);background:var(--pri-g);color:var(--pri)}
.badge{display:inline-flex;align-items:center;justify-content:center;padding:2px 10px;border-radius:6px;font-size:12px;font-weight:700;font-family:var(--mono)}
.badge-1{background:#065F46;color:#6EE7B7}.badge-2{background:#1E3A5F;color:#93C5FD}.badge-2e{background:#78350F;color:#FCD34D}.badge-3{background:#7C2D12;color:#FDBA74}.badge-3u{background:#7F1D1D;color:#FCA5A5}
.input{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:9px 14px;color:var(--txt);font-size:13px;font-family:var(--ff);outline:none;width:100%;transition:border .2s}
.tag{font-size:11px;padding:3px 10px;border-radius:6px;font-weight:600;display:inline-block}.tag-pri{background:var(--pri-g);color:var(--pri)}.tag-acc{background:var(--acc-g);color:var(--acc)}.tag-ok{background:var(--ok-g);color:var(--ok)}.tag-err{background:var(--err-g);color:var(--err)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9998;display:flex;align-items:center;justify-content:center}
.modal{background:var(--sidebar);border:1px solid var(--brd);border-radius:16px;padding:28px;width:95%;max-width:720px;max-height:90vh;overflow-y:auto;box-shadow:0 30px 80px rgba(0,0,0,0.5)}
.modal-title{font-size:18px;font-weight:800;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}.modal-close{background:none;border:none;color:var(--txt-m);font-size:22px;cursor:pointer}
.field{margin-bottom:14px}.field label{display:block;font-size:12px;color:var(--txt-m);font-weight:600;margin-bottom:5px}
.prompt-box{background:#070b14;border:1px solid var(--brd);border-radius:10px;padding:16px;font-family:var(--mono);font-size:11.5px;line-height:1.6;color:var(--txt-m);white-space:pre-wrap;max-height:350px;overflow:auto;position:relative}
.file-attach{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg);border:2px dashed var(--brd);border-radius:8px;cursor:pointer;font-size:12px;color:var(--txt-m);transition:border-color .2s}.file-attach:hover{border-color:var(--pri)}
.file-item{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg);border-radius:6px;font-size:12px;margin-top:4px}
.ai-box{background:linear-gradient(135deg,rgba(59,130,246,0.08),rgba(245,158,11,0.06));border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:16px;margin-top:16px}
.ai-box-title{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;color:var(--pri)}
.ai-step{display:flex;gap:12px;align-items:flex-start;margin-bottom:12px}.ai-step-num{width:24px;height:24px;border-radius:12px;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0}.ai-step-text{font-size:12px;color:var(--txt-m);flex:1}
.ai-response-area{width:100%;min-height:80px;background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:10px;color:var(--txt);font-size:12px;font-family:var(--mono)}
.ai-link{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--brd);color:var(--txt);text-decoration:none;transition:all .2s}.ai-link:hover{border-color:var(--pri);background:var(--pri-g)}
.gantt-header{display:flex;border-bottom:1px solid var(--brd);height:32px}.gantt-month{flex:1;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--txt-m);font-weight:700;border-right:1px solid var(--brd)}
.gantt-row{height:36px;border-bottom:1px solid var(--brd);position:relative}.gantt-bar{position:absolute;height:22px;top:7px;border-radius:6px;display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;color:#fff;overflow:hidden;white-space:nowrap;opacity:.85}
.gantt-task{height:36px;border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 12px;font-size:12px;font-weight:500;border-right:1px solid var(--brd);min-width:220px}
.dcat{padding:10px;background:var(--bg);border:1px solid var(--brd);border-radius:8px;margin-bottom:8px}.dcat-t{font-size:13px;font-weight:700;margin-bottom:6px}
.di{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;cursor:pointer;font-size:12px;margin-bottom:2px;transition:background .15s}.di:hover{background:var(--card-h)}.di.sel{background:var(--pri-g);outline:1px solid rgba(59,130,246,0.3)}
.evo-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--brd);font-size:12px}
*:focus-visible{outline:2px solid var(--pri);outline-offset:2px;border-radius:4px}*:focus:not(:focus-visible){outline:none}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}.fade-in{animation:fadeIn .3s ease-out}
@media(max-width:900px){.sidebar{width:66px;min-width:66px}.sidebar .sidebar-logo-text,.sidebar .nav-item span:not(.nav-icon){display:none}.grid-4{grid-template-columns:repeat(2,1fr)}.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app"><div class="app-layout">
  <nav class="sidebar" id="sb"><div class="sidebar-logo" onclick="document.getElementById('sb').classList.toggle('collapsed')"><div class="sidebar-logo-icon">OA</div><div class="sidebar-logo-text"><div style="font-size:16px;font-weight:800;letter-spacing:-.5px">OA Expert</div><div style="font-size:10px;color:var(--txt-m);font-weight:600;letter-spacing:1.5px;text-transform:uppercase">IA â€¢ Ouvrages d'Art</div></div></div><div class="sidebar-nav" id="sn"></div><div style="padding:14px 18px;border-top:1px solid var(--brd);font-size:10px;color:var(--txt-d);text-align:center">v4.0 â€” IA Interactive</div></nav>
  <main class="main-area"><header class="main-header"><div><h1 id="pt">Tableau de bord</h1><div class="sub" id="ps"></div></div><div style="font-size:11px;color:var(--ok);font-weight:600;display:flex;align-items:center;gap:4px"><span style="width:7px;height:7px;border-radius:4px;background:var(--ok);display:inline-block"></span> En ligne</div></header><div class="main-content" id="mc"></div></main>
</div></div>
<div id="mr"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GLOBAL STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let M='dashboard',selOuv=null,selDes=null,normsSearch='',normsOrg='all',planView='gantt',promptTopic='general',docType='pvid',nid=100;
function uid(){return++nid}
const CL=[{id:'ferroviaire',l:'Ferroviaire',i:'ğŸš†'},{id:'routier',l:'Routier',i:'ğŸ›£ï¸'},{id:'fluvial',l:'Fluvial',i:'âš“'},{id:'autre',l:'Autre',i:'ğŸ—ï¸'}];
let OUV=[],INS=[],DES=[],TASKS=[];

const MODS=[
  {id:'dashboard',l:'Tableau de bord',i:'ğŸ“Š',s:'Vue d\'ensemble'},
  {id:'ouvrages',l:'Ouvrages',i:'ğŸŒ‰',s:'Patrimoine'},
  {id:'inspections',l:'Inspections',i:'ğŸ”',s:'Campagnes'},
  {id:'desordres',l:'DÃ©sordres',i:'âš ï¸',s:'Registre et Ã©volution des avaries'},
  {id:'normes',l:'Base normative',i:'ğŸ“š',s:'RÃ©fÃ©rences techniques'},
  {id:'documents',l:'Documents',i:'ğŸ“„',s:'PV, Expertises, MÃ©moires'},
  {id:'planning',l:'Planning',i:'ğŸ“…',s:'Planification'},
  {id:'ai',l:'Assistant IA',i:'ğŸ¤–',s:'Prompts universels'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NORMS DATABASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NDB=[
  {o:"ITSEOA",r:"Fascicule 0",t:"Dispositions gÃ©nÃ©rales",d:"Surveillance",u:"https://www.ecologie.gouv.fr/politiques-publiques/instruction-technique-surveillance-entretien-ouvrages-dart-itseoa"},
  {o:"ITSEOA",r:"Fascicule 2",t:"Ouvrages en maÃ§onnerie",d:"Inspection",u:"https://www.ecologie.gouv.fr/politiques-publiques/instruction-technique-surveillance-entretien-ouvrages-dart-itseoa"},
  {o:"ITSEOA",r:"Fascicule 3",t:"BÃ©ton â€“ Fondations",d:"Inspection",u:"https://www.ecologie.gouv.fr/politiques-publiques/instruction-technique-surveillance-entretien-ouvrages-dart-itseoa"},
  {o:"ITSEOA",r:"Fascicule 11",t:"Ponts mÃ©talliques",d:"Inspection",u:""},
  {o:"ITSEOA",r:"Fascicule 21",t:"Appareils d'appui",d:"Inspection",u:""},
  {o:"ITSEOA",r:"Fascicule 32",t:"Murs de soutÃ¨nement",d:"Inspection",u:""},
  {o:"ITSEOA",r:"Fascicule 40",t:"Tunnels",d:"Inspection",u:""},
  {o:"CEREMA",r:"Guide IQOA Ponts",t:"Image QualitÃ© OA â€“ Ponts",d:"Cotation",u:"https://www.cerema.fr/fr/centre-ressources/boutique/image-qualite-ouvrages-art-ponts"},
  {o:"CEREMA",r:"Guide IQOA Murs",t:"Image QualitÃ© OA â€“ Murs",d:"Cotation",u:"https://www.cerema.fr/fr/centre-ressources/boutique/image-qualite-ouvrages-art-murs"},
  {o:"CEREMA",r:"Guide anticorrosion",t:"Protection ouvrages mÃ©talliques",d:"Protection",u:"https://www.cerema.fr/fr/centre-ressources/boutique/protection-ouvrages-metalliques-contre-corrosion"},
  {o:"CEREMA",r:"Guide fatigue",t:"RÃ©sistance fatigue ponts mÃ©talliques",d:"Calcul",u:"https://www.cerema.fr/fr/centre-ressources/boutique/resistance-fatigue"},
  {o:"CEREMA",r:"Guide surveillance",t:"Surveillance et entretien courant OA",d:"Surveillance",u:"https://www.cerema.fr/fr/centre-ressources/boutique/surveillance-entretien-courant-ouvrages-art-routiers"},
  {o:"SNCF",r:"IN 1256",t:"Surveillance et entretien OA",d:"Surveillance",u:""},
  {o:"SNCF",r:"IN 1260",t:"Cotation des dÃ©sordres",d:"Cotation",u:""},
  {o:"SNCF",r:"IN 1130",t:"SÃ©curitÃ© travaux ferroviaires",d:"SÃ©curitÃ©",u:""},
  {o:"SNCF",r:"IN 7012/00035",t:"RÃ©parations Ponts MÃ©talliques",d:"RÃ©paration",u:""},
  {o:"SNCF",r:"IN 00036",t:"Protection anticorrosion",d:"Protection",u:""},
  {o:"STRRES",r:"RECO NÂ°4",t:"RÃ©paration et renforcement",d:"RÃ©paration",u:"https://www.strres.org/"},
  {o:"NF EN",r:"EN 1090-2",t:"ExÃ©cution structures acier",d:"ExÃ©cution",u:"https://www.boutique.afnor.org/"},
  {o:"NF EN",r:"EN 1993 (EC3)",t:"Calcul structures acier",d:"Calcul",u:"https://www.boutique.afnor.org/"},
  {o:"NF EN",r:"ISO 12944",t:"Anticorrosion peinture",d:"Protection",u:"https://www.boutique.afnor.org/"},
  {o:"CCTG",r:"Fascicule 56",t:"Protection ouvrages mÃ©talliques",d:"Protection",u:"https://www.legifrance.gouv.fr/"},
  {o:"CCTG",r:"Fascicule 65",t:"ExÃ©cution ouvrages bÃ©ton",d:"ExÃ©cution",u:"https://www.legifrance.gouv.fr/"},
  {o:"CCTG",r:"Fascicule 66",t:"ExÃ©cution ponts mÃ©talliques",d:"ExÃ©cution",u:"https://www.legifrance.gouv.fr/"},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DISORDER CATALOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DCAT={"Pont mÃ©tallique":[{c:"Structure",i:["Fissure de fatigue","Fissure de fragilitÃ©","Corrosion gÃ©nÃ©ralisÃ©e","Corrosion localisÃ©e","Flambement local","Voilement de tÃ´le","DÃ©formation permanente","Perte de section"]},{c:"Assemblages",i:["Jeu excessif rivets","Rivet manquant","Rivet cisaillÃ©","Corrosion rivets","Fissure soudure","Rupture boulon HR","Desserrage boulon"]},{c:"Peinture/Protection",i:["Ã‰caillage peinture","Cloquage","Farinage","Rouille sous peinture","Absence protection"]},{c:"Appareils d'appui",i:["Distorsion Ã©lastomÃ¨re","Hernie","Glissement hors appui","Blocage mobile","Corrosion AA"]}],"Pont bÃ©ton armÃ©":[{c:"BÃ©ton",i:["Fissure longitudinale","Fissure transversale","Fissure en Ã©toile","Ã‰paufrure","Ã‰caillage","Nid de cailloux","Carbonatation","Alcali-rÃ©action","Gel/dÃ©gel"]},{c:"Armatures",i:["Corrosion armatures","Armatures apparentes","Ã‰clatement enrobage","Perte de section armatures"]},{c:"Ã‰tanchÃ©itÃ©",i:["DÃ©faut Ã©tanchÃ©itÃ©","Infiltration","Stalactite/efflorescence","Colmatage gargouille"]},{c:"AA",i:["Distorsion","Hernie","Glissement","Fissure bossage"]}],"Pont maÃ§onnerie":[{c:"MaÃ§onnerie",i:["Fissure voÃ»te longitudinale","Fissure voÃ»te transversale","Dislocation joints","Ã‰clatement pierre","Ã‰rosion mortier","DÃ©versement tympan"]},{c:"Fondations",i:["Affouillement","Ã‰rosion radier","Basculement pile","Tassement diffÃ©rentiel"]},{c:"Divers",i:["VÃ©gÃ©tation invasive","Efflorescence","Traces humiditÃ©"]}],"Tunnel":[{c:"VoÃ»te",i:["Fissure voÃ»te","Ã‰paufrure","Infiltration ponctuelle","Infiltration gÃ©nÃ©ralisÃ©e","Stalactite","DÃ©formation profil","Vide derriÃ¨re revÃªtement"]},{c:"Radier",i:["SoulÃ¨vement","Fissure radier","Colmatage caniveau"]}],"Mur de soutÃ¨nement":[{c:"Structure",i:["Basculement","Glissement","Fissure verticale","Fissure horizontale","Bombement","Ã‰rosion pied"]},{c:"Drainage",i:["Colmatage barbacanes","Pression hydrostatique","Absence drainage"]}],"Passerelle":[{c:"Structure",i:["Fissure fatigue","Corrosion","Flambement","DÃ©formation","Vibration excessive"]},{c:"Ã‰quipements",i:["DÃ©formation garde-corps","Corrosion garde-corps","Platelage dÃ©gradÃ©"]}],"Viaduc mixte":[{c:"Acier",i:["Fissure fatigue","Corrosion","Flambement","Voilement"]},{c:"Dalle bÃ©ton",i:["Fissure","Ã‰paufrure","Ã‰caillage","DÃ©faut Ã©tanchÃ©itÃ©"]},{c:"Connexion",i:["Cisaillement connecteurs","Fissure interface"]},{c:"AA",i:["Distorsion","Glissement","Corrosion"]}]};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AI SYSTEM PROMPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AIP=`Tu es OA Expert IA, assistant spÃ©cialisÃ© de haut niveau en inspection, maintenance et rÃ©paration d'ouvrages d'art (ponts, viaducs, passerelles, tunnels, murs de soutÃ¨nement).
EXPERTISE: PVID/IDP/VST, cotation IQOA et IN 1260, pathologies structures, rÃ©parations, anticorrosion ISO 12944, Eurocodes.
NORMES: ITSEOA, CEREMA, SNCF (IN 1256/1260/1130/7012/00035/00036), SETRA, LCPC, CETU, IMGC, STRRES RECO NÂ°4, EN 1090-2/1504/1991-1993, ISO 12944, CCTG Fasc. 56/65/66.
RÃ©ponds TOUJOURS en franÃ§ais technique. Cite les normes applicables.`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nav(m){M=m;selOuv=null;selDes=null;const mod=MODS.find(x=>x.id===m);document.getElementById('pt').textContent=mod?.l||'';document.getElementById('ps').textContent=mod?.s||'';bSB();R();}
function bSB(){const n=document.getElementById('sn');n.innerHTML='';MODS.forEach(m=>{n.innerHTML+=`<div class="nav-item ${M===m.id?'active':''}" onclick="nav('${m.id}')" title="${m.l}"><span class="nav-icon">${m.i}</span><span>${m.l}</span></div>`;});}
function iqB(c){const x={'1':'badge-1','2':'badge-2','2E':'badge-2e','3':'badge-3','3U':'badge-3u'}[c];return x?`<span class="badge ${x}">${c}</span>`:`<span class="tag tag-acc">${c||'NE'}</span>`;}
function cI(id){return CL.find(c=>c.id===id)?.i||'ğŸ—ï¸';}
function cL(id){return CL.find(c=>c.id===id)?.l||'';}
function clM(){document.getElementById('mr').innerHTML='';}
function esc(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function cpT(id){const t=document.getElementById(id)?.innerText;if(!t)return;navigator.clipboard.writeText(t).then(()=>{const s=document.getElementById(id+'s');if(s){s.textContent='âœ… CopiÃ© ! Collez dans votre IA.';setTimeout(()=>{s.textContent='';},4000);}});}
function shF(iid,lid){const fs=document.getElementById(iid).files,l=document.getElementById(lid);l.innerHTML='';for(const f of fs)l.innerHTML+=`<div class="file-item">ğŸ“„ ${f.name} <span class="c-d fs11">(${(f.size/1024).toFixed(0)}Ko)</span></div>`;}
function ouvCtx(o){
  let s=`Nom: ${o.nom} | Type: ${o.type} | Client: ${cL(o.client)} | IQOA: ${o.iqoa} | Mat: ${o.mat||'?'} | AnnÃ©e: ${o.annee||'?'} | Dim: ${o.long||'?'}m Ã— ${o.larg||'?'}m | Commune: ${o.commune||'?'} | Voie: ${o.voie||'?'}`;
  if(o.rem)s+=` | Rem: ${o.rem}`;
  const ds=DES.filter(d=>d.oid===o.id);
  if(ds.length){s+='\nDÃ‰SORDRES:';ds.forEach(d=>{s+=`\n- ${d.type} (sÃ©v.${d.sev}) sur ${d.elem||'?'}`;if(d.evol?.length>1){const f=d.evol[0],l=d.evol.at(-1);s+=` | Ã‰volution: ${f.val}${d.unit||''} (${f.date}) â†’ ${l.val}${d.unit||''} (${l.date}) [+${((l.val/f.val-1)*100).toFixed(0)}%]`;}});}
  return s;
}
function aiLinks(){return `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"><a href="https://copilot.microsoft.com" target="_blank" class="ai-link">ğŸŸ¢ Copilot</a><a href="https://chatgpt.com" target="_blank" class="ai-link">ğŸŸ£ ChatGPT</a><a href="https://gemini.google.com" target="_blank" class="ai-link">ğŸ”µ Gemini</a><a href="https://claude.ai" target="_blank" class="ai-link">ğŸŸ  Claude</a><a href="https://chat.mistral.ai" target="_blank" class="ai-link">âšª Mistral</a></div>`;}
function aiInteractBox(promptId,parseFunc){
  return `<div class="ai-box">
    <div class="ai-box-title">ğŸ¤– Interaction IA</div>
    <div class="ai-step"><div class="ai-step-num">1</div><div class="ai-step-text">Copiez le prompt ci-dessus et collez-le dans votre IA prÃ©fÃ©rÃ©e :</div></div>
    ${aiLinks()}
    <div class="ai-step" style="margin-top:14px"><div class="ai-step-num">2</div><div class="ai-step-text">Copiez la rÃ©ponse de l'IA et collez-la ci-dessous :</div></div>
    <textarea class="ai-response-area" id="${promptId}_resp" rows="5" placeholder="Collez ici la rÃ©ponse complÃ¨te de l'IA..."></textarea>
    <button class="btn btn-acc" style="margin-top:10px" onclick="${parseFunc}('${promptId}_resp')">ğŸ“¥ IntÃ©grer la rÃ©ponse</button>
    <span id="${promptId}_status" class="fs12 c-ok" style="margin-left:10px"></span>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RENDER DISPATCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function R(){
  const el=document.getElementById('mc');
  const fn={dashboard:rDash,ouvrages:rOuv,inspections:rInsp,desordres:rDes,normes:rNormes,documents:rDocs,planning:rPlan,ai:rAI};
  (fn[M]||rDash)(el);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rDash(el){
  const n3U=DES.filter(d=>d.sev==='3U').length;
  el.innerHTML=`<div class="fade-in"><div class="grid-4" style="margin-bottom:24px">${[{l:'Ouvrages',v:OUV.length,c:'var(--pri)'},{l:'DÃ©sordres',v:DES.length,c:'var(--err)',s:n3U+' en 3U'},{l:'Inspections',v:INS.length,c:'var(--acc)'},{l:'TÃ¢ches',v:TASKS.length,c:'var(--ok)'}].map(s=>`<div class="card" style="border-top:3px solid ${s.c}"><div class="stat-num" style="color:${s.c}">${s.v}</div><div class="stat-label">${s.l}</div>${s.s?`<div class="stat-sub">${s.s}</div>`:''}</div>`).join('')}</div>
  ${OUV.length===0?`<div class="card" style="text-align:center;padding:48px"><div style="font-size:48px;margin-bottom:16px">ğŸŒ‰</div><div class="fw700" style="font-size:18px;margin-bottom:8px">Bienvenue sur OA Expert v4</div><div class="c-m" style="margin-bottom:20px">Commencez par crÃ©er un ouvrage â€” l'IA vous aidera Ã  complÃ©ter les donnÃ©es.</div><button class="btn btn-pri" onclick="nav('ouvrages');mNO()">+ CrÃ©er un ouvrage</button></div>`
  :`<div class="card"><div class="card-title">ğŸŒ‰ Ouvrages</div><table><thead><tr><th>Nom</th><th>Type</th><th>IQOA</th><th>DÃ©sordres</th></tr></thead><tbody>${OUV.map(o=>{const nd=DES.filter(d=>d.oid===o.id).length;return`<tr class="clickable" onclick="selOuv=${o.id};nav('ouvrages')"><td class="fw600">${o.nom}</td><td class="c-m fs12">${o.type}</td><td>${iqB(o.iqoa)}</td><td class="fw600 ${nd>0?'c-err':''}">${nd}</td></tr>`;}).join('')}</tbody></table></div>`}
  ${DES.filter(d=>d.evol?.length>1).length?`<div class="card"><div class="card-title">ğŸ“ˆ Ã‰volutions rÃ©centes</div>${DES.filter(d=>d.evol?.length>1).slice(-4).map(d=>{const o=OUV.find(x=>x.id===d.oid);const f=d.evol[0],l=d.evol.at(-1);const pct=((l.val/f.val-1)*100).toFixed(0);return`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--brd)"><div><span class="fw600">${d.type}</span> <span class="c-m fs12">sur ${o?.nom||'?'}</span></div><div style="display:flex;align-items:center;gap:8px"><span class="fs12 c-m">${f.val} â†’ ${l.val} ${d.unit||''}</span><span class="tag ${parseInt(pct)>50?'tag-err':'tag-acc'}">+${pct}%</span></div></div>`;}).join('')}</div>`:''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OUVRAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mNO(){document.getElementById('mr').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)clM()"><div class="modal">
  <div class="modal-title"><span>ğŸŒ‰ Nouvel ouvrage</span><button class="modal-close" onclick="clM()">âœ•</button></div>
  <div class="grid-2"><div class="field"><label>Nom *</label><input class="input" id="on" placeholder="Ex: Pont de Pontorson (PK 342+120)"></div>
    <div class="field"><label>Type *</label><select class="input" id="ot"><option>Pont mÃ©tallique</option><option>Pont bÃ©ton armÃ©</option><option>Pont maÃ§onnerie</option><option>Viaduc mixte</option><option>Passerelle</option><option>Tunnel</option><option>Mur de soutÃ¨nement</option></select></div>
    <div class="field"><label>Client</label><select class="input" id="oc">${CL.map(c=>`<option value="${c.id}">${c.i} ${c.l}</option>`).join('')}</select></div>
    <div class="field"><label>IQOA</label><select class="input" id="oq"><option>NE</option><option>1</option><option>2</option><option>2E</option><option>3</option><option>3U</option></select></div></div>
  <div class="field"><label>MatÃ©riaux</label><input class="input" id="om" placeholder="Acier, bÃ©ton armÃ©..."></div>
  <div class="grid-3"><div class="field"><label>AnnÃ©e</label><input class="input" id="oy" placeholder="1892"></div><div class="field"><label>Longueur (m)</label><input class="input" id="ol" placeholder="45.5"></div><div class="field"><label>Largeur (m)</label><input class="input" id="ow" placeholder="8.2"></div></div>
  <div class="grid-2"><div class="field"><label>Commune</label><input class="input" id="ox"></div><div class="field"><label>Voie</label><input class="input" id="ov" placeholder="LGV / RD976..."></div></div>
  <div class="field"><label>Remarques</label><textarea class="input" id="or" rows="3" placeholder="TravÃ©es, fondations, particularitÃ©s..."></textarea></div>
  <div class="field"><label>ğŸ“ PiÃ¨ces jointes (plans, photos, anciens rapports)</label><input type="file" id="of" multiple style="display:none" onchange="shF('of','ofl')"><div class="file-attach" onclick="document.getElementById('of').click()">ğŸ“ Cliquer pour ajouter</div><div id="ofl"></div></div>
  <div class="ai-box"><div class="ai-box-title">ğŸ¤– ComplÃ©ter avec l'IA</div>
    <div class="c-m fs12" style="margin-bottom:10px">L'IA peut complÃ©ter les donnÃ©es manquantes Ã  partir de vos informations ou piÃ¨ces jointes.</div>
    <button class="btn btn-pri btn-sm" onclick="genOuvPrompt()">ğŸ”§ GÃ©nÃ©rer le prompt de complÃ©tion</button>
    <div id="ouv-ai-zone"></div>
  </div>
  <div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-pri" onclick="sNO()">âœ… CrÃ©er l'ouvrage</button><button class="btn btn-ghost" onclick="clM()">Annuler</button></div>
</div></div>`;}

function genOuvPrompt(){
  const nom=document.getElementById('on').value||'[nom Ã  complÃ©ter]';
  const type=document.getElementById('ot').value;
  const files=[...document.getElementById('of').files].map(f=>f.name);
  const p=AIP+`\n\nJe crÃ©e une fiche ouvrage. ComplÃ¨te les donnÃ©es manquantes et propose des informations techniques pertinentes.\nDonnÃ©es actuelles:\n- Nom: ${nom}\n- Type: ${type}\n- MatÃ©riaux: ${document.getElementById('om').value||'?'}\n- AnnÃ©e: ${document.getElementById('oy').value||'?'}\n- Commune: ${document.getElementById('ox').value||'?'}${files.length?'\n- Documents joints: '+files.join(', '):''}
\nRÃ©ponds avec ces informations COMPLÃ‰TÃ‰ES au format structurÃ©:\n- MatÃ©riaux probables:\n- Nombre de travÃ©es probable:\n- Type de fondations probable:\n- Normes applicables:\n- DÃ©sordres typiques Ã  surveiller pour ce type d'ouvrage:\n- Recommandations d'inspection:\n- Toute autre information technique utile:`;
  document.getElementById('ouv-ai-zone').innerHTML=`<div class="prompt-box" id="ouvp" style="margin-top:12px">${esc(p)}</div>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-pri btn-sm" onclick="cpT('ouvp')">ğŸ“‹ Copier</button><span id="ouvps" class="fs12 c-ok"></span></div>
    ${aiInteractBox('ouvp','parseOuvResp')}`;
}

function parseOuvResp(id){
  const resp=document.getElementById(id).value.trim();
  if(!resp){alert('Collez d\'abord la rÃ©ponse de l\'IA');return;}
  const rem=document.getElementById('or');
  rem.value=(rem.value?rem.value+'\n\n':'')+'--- DonnÃ©es complÃ©tÃ©es par IA ---\n'+resp;
  document.getElementById(id.replace('_resp','_status')).textContent='âœ… RÃ©ponse intÃ©grÃ©e dans les remarques !';
}

function sNO(){const n=document.getElementById('on').value.trim();if(!n)return alert('Nom obligatoire');OUV.push({id:uid(),nom:n,type:document.getElementById('ot').value,client:document.getElementById('oc').value,iqoa:document.getElementById('oq').value,mat:document.getElementById('om').value,annee:document.getElementById('oy').value,long:document.getElementById('ol').value,larg:document.getElementById('ow').value,commune:document.getElementById('ox').value,voie:document.getElementById('ov').value,rem:document.getElementById('or').value,files:[...document.getElementById('of').files].map(f=>f.name),created:new Date().toISOString().slice(0,10)});clM();R();}

function rOuv(el){
  if(selOuv){const o=OUV.find(x=>x.id===selOuv);if(!o){selOuv=null;return rOuv(el);}const ds=DES.filter(d=>d.oid===o.id);
    el.innerHTML=`<div class="fade-in"><div style="cursor:pointer;color:var(--txt-m);font-size:13px;margin-bottom:20px" onclick="selOuv=null;R()">â† Retour</div>
      <div class="card"><div style="display:flex;justify-content:space-between"><div><div style="font-size:20px;font-weight:800;margin-bottom:6px">${o.nom}</div><div class="c-m">${o.type} â€¢ ${cI(o.client)} ${cL(o.client)}</div></div>${iqB(o.iqoa)}</div>
        <div class="grid-3" style="margin-top:20px">${[['MatÃ©riaux',o.mat||'â€“'],['AnnÃ©e',o.annee||'â€“'],['Dimensions',(o.long||'?')+'m Ã— '+(o.larg||'?')+'m'],['Commune',o.commune||'â€“'],['Voie',o.voie||'â€“'],['CrÃ©Ã©',o.created]].map(([l,v])=>`<div style="padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--brd)"><div class="fs11 c-m fw600" style="text-transform:uppercase">${l}</div><div class="fs13 fw600" style="margin-top:4px">${v}</div></div>`).join('')}</div>
        ${o.rem?`<div style="margin-top:14px;padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--brd)"><div class="fs11 c-m fw600">REMARQUES</div><div class="fs13" style="margin-top:4px;white-space:pre-line">${o.rem}</div></div>`:''}
      </div>
      <div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><div class="card-title" style="margin:0">âš ï¸ DÃ©sordres (${ds.length})</div><button class="btn btn-pri btn-sm" onclick="mND(${o.id})">+ Ajouter</button></div>
        ${ds.length?`<table><thead><tr><th>Type</th><th>Ã‰lÃ©ment</th><th>SÃ©vÃ©ritÃ©</th><th>Mesures</th><th></th></tr></thead><tbody>${ds.map(d=>`<tr class="clickable" onclick="selDes=${d.id};nav('desordres')"><td class="fw600">${d.type}</td><td class="c-m">${d.elem||'â€“'}</td><td>${iqB(d.sev)}</td><td class="fs12">${d.evol?.length||0} pts</td><td class="c-pri fs12">Voir â†—</td></tr>`).join('')}</tbody></table>`:'<div class="c-m fs13" style="text-align:center;padding:20px">Aucun dÃ©sordre</div>'}
      </div></div>`;return;}
  el.innerHTML=`<div class="fade-in"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">ğŸŒ‰ Patrimoine (${OUV.length})</div><button class="btn btn-pri" onclick="mNO()">+ Nouvel ouvrage</button></div>
    ${OUV.length?`<table><thead><tr><th>Ouvrage</th><th>Type</th><th>Client</th><th>IQOA</th><th>DÃ©sordres</th></tr></thead><tbody>${OUV.map(o=>{const nd=DES.filter(d=>d.oid===o.id).length;return`<tr class="clickable" onclick="selOuv=${o.id};R()"><td class="fw600">${o.nom}</td><td class="c-m fs12">${o.type}</td><td>${cI(o.client)} <span class="c-m fs12">${cL(o.client)}</span></td><td>${iqB(o.iqoa)}</td><td class="fw600 ${nd?'c-err':''}">${nd}</td></tr>`;}).join('')}</tbody></table>`:'<div class="c-m fs13" style="text-align:center;padding:32px">Cliquez sur "+ Nouvel ouvrage" pour commencer.</div>'}
  </div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INSPECTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mNI(){if(!OUV.length)return alert('CrÃ©ez d\'abord un ouvrage');document.getElementById('mr').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)clM()"><div class="modal">
  <div class="modal-title"><span>ğŸ” Nouvelle campagne</span><button class="modal-close" onclick="clM()">âœ•</button></div>
  <div class="grid-2"><div class="field"><label>Ouvrage(s) *</label><select class="input" id="io" multiple style="height:80px">${OUV.map(o=>`<option value="${o.id}">${o.nom}</option>`).join('')}</select></div>
    <div class="field"><label>Type</label><select class="input" id="it"><option>PVID</option><option>IDP</option><option>VST</option><option>Expertise</option><option>Inspection subaquatique</option><option>Surveillance renforcÃ©e</option></select></div></div>
  <div class="grid-2"><div class="field"><label>Date</label><input type="date" class="input" id="id" value="${new Date().toISOString().slice(0,10)}"></div><div class="field"><label>Inspecteur(s)</label><input class="input" id="ii"></div></div>
  <div class="field"><label>Moyens</label><input class="input" id="im" placeholder="Nacelle, drone..."></div>
  <div class="field"><label>ğŸ“ Documents</label><input type="file" id="if2" multiple style="display:none" onchange="shF('if2','ifl')"><div class="file-attach" onclick="document.getElementById('if2').click()">ğŸ“ Ajouter</div><div id="ifl"></div></div>
  <div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-pri" onclick="sNI()">âœ… CrÃ©er</button><button class="btn btn-ghost" onclick="clM()">Annuler</button></div>
</div></div>`;}
function sNI(){const s=[...document.getElementById('io').selectedOptions].map(o=>parseInt(o.value));if(!s.length)return alert('SÃ©lectionnez un ouvrage');INS.push({id:uid(),ouvs:s,type:document.getElementById('it').value,date:document.getElementById('id').value,insp:document.getElementById('ii').value,moyens:document.getElementById('im').value});clM();R();}
function rInsp(el){el.innerHTML=`<div class="fade-in"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">ğŸ” Campagnes (${INS.length})</div><button class="btn btn-pri" onclick="mNI()">+ Nouvelle campagne</button></div>
  ${INS.length?`<table><thead><tr><th>RÃ©f.</th><th>Ouvrage(s)</th><th>Type</th><th>Date</th><th>Inspecteur</th></tr></thead><tbody>${INS.map(c=>`<tr><td class="fw700 c-acc fs12">INS-${String(c.id).padStart(3,'0')}</td><td class="fw600 fs12">${c.ouvs.map(oid=>OUV.find(o=>o.id===oid)?.nom||'?').join(', ')}</td><td><span class="tag tag-pri">${c.type}</span></td><td class="fs12">${c.date}</td><td class="fs12">${c.insp||'â€“'}</td></tr>`).join('')}</tbody></table>`:'<div class="c-m fs13" style="text-align:center;padding:32px">Aucune campagne.</div>'}
</div></div>`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DESORDRES + EVOLUTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mND(preOuv){if(!OUV.length)return alert('CrÃ©ez d\'abord un ouvrage');const ft=OUV[0]?.type;document.getElementById('mr').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)clM()"><div class="modal" style="max-width:780px">
  <div class="modal-title"><span>âš ï¸ Nouveau dÃ©sordre</span><button class="modal-close" onclick="clM()">âœ•</button></div>
  <div class="grid-2"><div class="field"><label>Ouvrage *</label><select class="input" id="do2" onchange="uDC()">${OUV.map(o=>`<option value="${o.id}" data-type="${o.type}" ${preOuv==o.id?'selected':''}>${o.nom}</option>`).join('')}</select></div>
    <div class="field"><label>SÃ©vÃ©ritÃ©</label><select class="input" id="ds"><option>1</option><option>2</option><option selected>2E</option><option>3</option><option>3U</option></select></div></div>
  <div class="field"><label>Localisation / Ã‰lÃ©ment</label><input class="input" id="de" placeholder="Poutre PG, TravÃ©e 3..."></div>
  <div class="card" style="background:var(--bg);max-height:250px;overflow-y:auto" id="dcl">${bDL(preOuv?OUV.find(o=>o.id===preOuv)?.type:ft)}</div>
  <div class="field" style="margin-top:10px"><label>Saisie manuelle</label><div style="display:flex;gap:8px"><input class="input" id="dcu" placeholder="Nouveau type..."><button class="btn btn-ghost btn-sm" onclick="aCD()">+ Ajouter</button></div></div>
  <div class="grid-3"><div class="field"><label>Valeur mesurÃ©e</label><input class="input" id="dv" placeholder="Ex: 0.5" type="number" step="0.01"></div>
    <div class="field"><label>UnitÃ©</label><select class="input" id="du"><option>mm</option><option>cm</option><option>m</option><option>mÂ²</option><option>%</option><option>sans</option></select></div>
    <div class="field"><label>Date mesure</label><input type="date" class="input" id="ddt" value="${new Date().toISOString().slice(0,10)}"></div></div>
  <div style="display:flex;gap:10px;margin-top:16px"><button class="btn btn-pri" onclick="sND()">âœ… Enregistrer</button><button class="btn btn-ghost" onclick="clM()">Annuler</button></div>
</div></div>`;}

function bDL(t){const cs=DCAT[t||'Pont mÃ©tallique']||DCAT['Pont mÃ©tallique'];return`<div class="fs12 c-m fw600" style="margin-bottom:8px">ğŸ“‹ Catalogue â€” ${t||'Pont mÃ©tallique'}</div>`+cs.map(c=>`<div class="dcat"><div class="dcat-t">${c.c}</div>${c.i.map(it=>`<div class="di" onclick="this.classList.toggle('sel')" data-name="${it}"><span style="width:14px;height:14px;border-radius:3px;border:2px solid var(--brd);display:inline-block;flex-shrink:0"></span>${it}</div>`).join('')}</div>`).join('');}
function uDC(){const s=document.getElementById('do2');document.getElementById('dcl').innerHTML=bDL(s.options[s.selectedIndex].dataset.type);}
function aCD(){const v=document.getElementById('dcu').value.trim();if(!v)return;document.getElementById('dcl').innerHTML+=`<div class="di sel" data-name="${v}"><span style="width:14px;height:14px;border-radius:3px;border:2px solid var(--pri);background:var(--pri-g);display:inline-block;flex-shrink:0"></span>${v} <span class="tag tag-acc" style="margin-left:8px">Manuel</span></div>`;document.getElementById('dcu').value='';}

function sND(){
  const oid=parseInt(document.getElementById('do2').value),sev=document.getElementById('ds').value,elem=document.getElementById('de').value;
  const val=parseFloat(document.getElementById('dv').value),unit=document.getElementById('du').value,ddate=document.getElementById('ddt').value;
  const sel=[...document.querySelectorAll('.di.sel')].map(e=>e.dataset.name);
  if(!sel.length)return alert('SÃ©lectionnez un dÃ©sordre');
  sel.forEach(type=>{
    const evol=val?[{date:ddate,val}]:[];
    DES.push({id:uid(),oid,type,elem,sev,unit:unit!=='sans'?unit:'',evol,date:ddate||new Date().toISOString().slice(0,10)});
  });clM();R();
}

// Add measurement to existing defect
function mAddMes(did){
  const d=DES.find(x=>x.id===did);if(!d)return;
  document.getElementById('mr').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)clM()"><div class="modal" style="max-width:450px">
    <div class="modal-title"><span>ğŸ“ Nouvelle mesure</span><button class="modal-close" onclick="clM()">âœ•</button></div>
    <div class="c-m fs13" style="margin-bottom:16px"><strong>${d.type}</strong> sur ${d.elem||'â€“'}</div>
    <div class="grid-3"><div class="field"><label>Valeur</label><input class="input" id="mv" type="number" step="0.01" placeholder="0.00"></div>
      <div class="field"><label>UnitÃ©</label><input class="input" id="mu" value="${d.unit||'mm'}" readonly></div>
      <div class="field"><label>Date</label><input type="date" class="input" id="md" value="${new Date().toISOString().slice(0,10)}"></div></div>
    <div class="field"><label>SÃ©vÃ©ritÃ© actuelle</label><select class="input" id="ms"><option ${d.sev==='1'?'selected':''}>1</option><option ${d.sev==='2'?'selected':''}>2</option><option ${d.sev==='2E'?'selected':''}>2E</option><option ${d.sev==='3'?'selected':''}>3</option><option ${d.sev==='3U'?'selected':''}>3U</option></select></div>
    <button class="btn btn-pri" onclick="sAddMes(${did})">âœ… Enregistrer</button>
  </div></div>`;
}
function sAddMes(did){
  const d=DES.find(x=>x.id===did);if(!d)return;
  const val=parseFloat(document.getElementById('mv').value);if(isNaN(val))return alert('Valeur requise');
  d.evol.push({date:document.getElementById('md').value,val});
  d.evol.sort((a,b)=>a.date.localeCompare(b.date));
  d.sev=document.getElementById('ms').value;
  d.date=document.getElementById('md').value;
  clM();R();
}

function drawEvo(id){
  const d=DES.find(x=>x.id===id);if(!d||!d.evol?.length)return;
  const svg=d3.select('#evo-'+id);svg.selectAll('*').remove();
  const rect=document.getElementById('evo-'+id)?.getBoundingClientRect();
  const w=rect?.width||400,h=160,m={t:15,r:15,b:30,l:45};
  svg.attr('viewBox',`0 0 ${w} ${h}`);
  const data=d.evol,color=d.sev==='3U'?'#EF4444':d.sev==='3'?'#F59E0B':'#3B82F6';
  const x=d3.scalePoint().domain(data.map(d=>d.date)).range([m.l,w-m.r]).padding(0.2);
  const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.val)*1.3]).range([h-m.b,m.t]);
  const line=d3.line().x(d=>x(d.date)).y(d=>y(d.val)).curve(d3.curveMonotoneX);
  const area=d3.area().x(d=>x(d.date)).y0(h-m.b).y1(d=>y(d.val)).curve(d3.curveMonotoneX);
  const gd=svg.append('defs').append('linearGradient').attr('id','ag'+id).attr('x1',0).attr('y1',0).attr('x2',0).attr('y2',1);
  gd.append('stop').attr('offset','0%').attr('stop-color',color).attr('stop-opacity',0.3);
  gd.append('stop').attr('offset','100%').attr('stop-color',color).attr('stop-opacity',0.02);
  svg.append('path').datum(data).attr('d',area).attr('fill','url(#ag'+id+')');
  svg.append('path').datum(data).attr('d',line).attr('fill','none').attr('stroke',color).attr('stroke-width',2.5);
  data.forEach(p=>{svg.append('circle').attr('cx',x(p.date)).attr('cy',y(p.val)).attr('r',4).attr('fill','#141D2F').attr('stroke',color).attr('stroke-width',2);
    svg.append('text').attr('x',x(p.date)).attr('y',y(p.val)-10).attr('text-anchor','middle').attr('fill',color).attr('font-size',10).attr('font-weight',700).attr('font-family',"'JetBrains Mono'").text(p.val);});
  svg.append('g').attr('transform',`translate(0,${h-m.b})`).call(d3.axisBottom(x).tickSize(0)).select('.domain').remove();
  svg.selectAll('.tick text').attr('fill','#8B9DC3').attr('font-size',9).attr('font-family',"'JetBrains Mono'");
}

function rDes(el){
  if(selDes){const d=DES.find(x=>x.id===selDes);if(!d){selDes=null;return rDes(el);}
    const o=OUV.find(x=>x.id===d.oid);const hasEvo=d.evol?.length>1;
    const pct=hasEvo?((d.evol.at(-1).val/d.evol[0].val-1)*100).toFixed(0):'â€“';
    el.innerHTML=`<div class="fade-in"><div style="cursor:pointer;color:var(--txt-m);font-size:13px;margin-bottom:20px" onclick="selDes=null;R()">â† Retour</div>
      <div class="grid-2">
        <div class="card"><div class="card-title">Fiche dÃ©sordre #${d.id}</div>
          ${[['Ouvrage',o?.nom||'?'],['Type',d.type],['Ã‰lÃ©ment',d.elem||'â€“'],['SÃ©vÃ©ritÃ©',iqB(d.sev)],['UnitÃ©',d.unit||'â€“'],['Date',d.date]].map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--brd)"><span class="c-m fs13">${l}</span><span class="fw600 fs13">${v}</span></div>`).join('')}
          <div style="margin-top:16px;display:flex;gap:8px"><button class="btn btn-pri btn-sm" onclick="mAddMes(${d.id})">ğŸ“ Nouvelle mesure</button><button class="btn btn-acc btn-sm" onclick="genDesExpertise(${d.id})">ğŸ”¬ Expertise IA</button></div>
        </div>
        <div class="card"><div class="card-title">ğŸ“ˆ Ã‰volution${hasEvo?' ('+d.evol.length+' mesures)':''}</div>
          ${d.evol?.length?`<svg id="evo-${d.id}" style="width:100%;height:160px"></svg>`:'<div class="c-m fs13" style="text-align:center;padding:20px">Pas encore de mesures</div>'}
          ${hasEvo?`<div style="margin-top:12px;padding:12px;background:${d.sev==='3U'?'var(--err-g)':'var(--acc-g)'};border-radius:8px;border:1px solid ${d.sev==='3U'?'rgba(239,68,68,0.3)':'rgba(245,158,11,0.3)'}">
            <div class="fs12 fw700" style="color:${d.sev==='3U'?'var(--err)':'var(--acc)'}">âš ï¸ Progression : +${pct}%</div>
            <div class="fs11 c-m">${d.evol[0].val}${d.unit} (${d.evol[0].date}) â†’ ${d.evol.at(-1).val}${d.unit} (${d.evol.at(-1).date})</div></div>`:''}
          ${d.evol?.length?`<div style="margin-top:12px">${d.evol.map(e=>`<div class="evo-row"><span class="fw600" style="min-width:80px;font-family:var(--mono)">${e.date}</span><span class="c-pri fw700">${e.val} ${d.unit}</span></div>`).join('')}</div>`:''}
        </div>
      </div>
      <div id="des-ai-zone"></div>
    </div>`;
    if(d.evol?.length)setTimeout(()=>drawEvo(d.id),100);return;
  }
  el.innerHTML=`<div class="fade-in"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">âš ï¸ DÃ©sordres (${DES.length})</div><button class="btn btn-pri" onclick="mND()">+ Nouveau dÃ©sordre</button></div>
    ${DES.length?`<table><thead><tr><th>Ouvrage</th><th>Type</th><th>Ã‰lÃ©ment</th><th>SÃ©vÃ©ritÃ©</th><th>Mesures</th><th>Ã‰volution</th></tr></thead><tbody>${DES.map(d=>{const o=OUV.find(x=>x.id===d.oid);const hasE=d.evol?.length>1;const pct=hasE?((d.evol.at(-1).val/d.evol[0].val-1)*100).toFixed(0):'â€“';return`<tr class="clickable" onclick="selDes=${d.id};R()"><td class="fs12">${o?.nom||'?'}</td><td class="fw600">${d.type}</td><td class="c-m fs12">${d.elem||'â€“'}</td><td>${iqB(d.sev)}</td><td class="fs12">${d.evol?.length||0}</td><td>${hasE?`<span class="tag ${parseInt(pct)>50?'tag-err':'tag-acc'}">+${pct}%</span>`:'â€“'}</td></tr>`;}).join('')}</tbody></table>`:'<div class="c-m fs13" style="text-align:center;padding:32px">Aucun dÃ©sordre.</div>'}
  </div></div>`;
}

function genDesExpertise(did){
  const d=DES.find(x=>x.id===did);if(!d)return;const o=OUV.find(x=>x.id===d.oid);
  const p=AIP+`\n\nRÃ©alise une EXPERTISE PATHOLOGIQUE pour ce dÃ©sordre :\n${ouvCtx(o)}\n\nDÃ‰SORDRE CIBLÃ‰: ${d.type} (sÃ©vÃ©ritÃ© ${d.sev}) sur ${d.elem||'Ã©lÃ©ment non prÃ©cisÃ©'}\nMesures: ${d.evol?.map(e=>e.val+' '+d.unit+' le '+e.date).join(', ')||'aucune'}
\nStructure attendue:\n1. Description du dÃ©sordre\n2. Analyse des causes probables\n3. Ã‰valuation de la sÃ©vÃ©ritÃ© et Ã©volution prÃ©visible\n4. PrÃ©conisations de rÃ©paration (avec normes : STRRES RECO NÂ°4, guides CEREMA, etc.)\n5. Urgence d'intervention\n6. Estimatif budgÃ©taire indicatif`;
  document.getElementById('des-ai-zone').innerHTML=`<div class="card" style="border-top:3px solid var(--acc)"><div class="card-title">ğŸ”¬ Expertise IA</div>
    <div class="prompt-box" id="desxp">${esc(p)}</div>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-pri btn-sm" onclick="cpT('desxp')">ğŸ“‹ Copier</button><span id="desxps" class="fs12 c-ok"></span></div>
    ${aiInteractBox('desxp','parseDesResp')}
  </div>`;
}
function parseDesResp(id){
  const resp=document.getElementById(id).value.trim();if(!resp)return alert('Collez la rÃ©ponse');
  const d=DES.find(x=>x.id===selDes);if(d){d.expertise=resp;}
  document.getElementById(id.replace('_resp','_status')).textContent='âœ… Expertise enregistrÃ©e !';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NORMES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rNormes(el){
  const orgs=[...new Set(NDB.map(n=>n.o))];
  const f=NDB.filter(n=>(normsOrg==='all'||n.o===normsOrg)&&(normsSearch===''||(n.t+n.r+n.o+n.d).toLowerCase().includes(normsSearch.toLowerCase())));
  el.innerHTML=`<div class="fade-in"><div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center">
    <input class="input" id="ns" style="max-width:300px" placeholder="ğŸ” Rechercher..." value="${normsSearch}">
    <span class="pill ${normsOrg==='all'?'active':''}" onclick="normsOrg='all';R()">Tous</span>
    ${orgs.map(o=>`<span class="pill ${normsOrg===o?'active':''}" onclick="normsOrg='${o}';R()">${o}</span>`).join('')}
  </div><div class="card"><div class="card-title">ğŸ“š Base (${f.length}/${NDB.length})</div>
    <table><thead><tr><th>Org.</th><th>RÃ©f.</th><th>Titre</th><th>Domaine</th><th>Lien</th></tr></thead>
    <tbody>${f.map(n=>`<tr><td class="fw700 fs12 c-acc">${n.o}</td><td class="fw600 fs12" style="font-family:var(--mono)">${n.r}</td><td>${n.t}</td><td><span class="tag tag-pri">${n.d}</span></td><td>${n.u?`<a href="${n.u}" target="_blank" class="fs12">ğŸ“„ Consulter</a>`:'<span class="fs11 c-d">â€”</span>'}</td></tr>`).join('')}</tbody></table>
  </div></div>`;
  document.getElementById('ns')?.addEventListener('input',e=>{normsSearch=e.target.value;R();});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DOCUMENTS (PV, Expertise, MÃ©moire) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rDocs(el){
  const types=[{id:'pvid',l:'ğŸ“‹ PV Inspection'},{id:'expertise',l:'ğŸ”¬ Expertise'},{id:'memoire',l:'ğŸ“ MÃ©moire technique'}];
  el.innerHTML=`<div class="fade-in">
    <div style="display:flex;gap:8px;margin-bottom:20px">${types.map(t=>`<span class="pill ${docType===t.id?'active':''}" onclick="docType='${t.id}';R()">${t.l}</span>`).join('')}</div>
    <div class="card" style="border-top:3px solid var(--pri)">
      <div class="card-title">${docType==='pvid'?'ğŸ“‹ GÃ©nÃ©rateur PV d\'inspection':docType==='expertise'?'ğŸ”¬ Compte-rendu d\'expertise':'ğŸ“ MÃ©moire technique'}</div>
      <div class="c-m fs13" style="margin-bottom:16px">Renseignez les donnÃ©es, l'IA gÃ©nÃ©rera le document complet avec toutes les donnÃ©es de la plateforme (ouvrages, dÃ©sordres, Ã©volutions).</div>
      <div class="grid-2"><div class="field"><label>Ouvrage</label><select class="input" id="do">${OUV.length?OUV.map(o=>`<option value="${o.id}">${o.nom}</option>`).join(''):'<option>â€” CrÃ©ez un ouvrage â€”</option>'}</select></div>
        ${docType==='pvid'?`<div class="field"><label>Format</label><select class="input" id="df"><option value="routier">ğŸ›£ï¸ Routier (CEREMA/IQOA)</option><option value="sncf">ğŸš† Ferroviaire (SNCF/IN 1256)</option></select></div>`:'<div></div>'}
      </div>
      <div class="grid-2"><div class="field"><label>Date</label><input type="date" class="input" id="dd" value="${new Date().toISOString().slice(0,10)}"></div><div class="field"><label>RÃ©dacteur(s)</label><input class="input" id="di2" placeholder="Noms"></div></div>
      ${docType==='pvid'?`<div class="grid-2"><div class="field"><label>Moyens</label><input class="input" id="dm" placeholder="Nacelle, drone..."></div><div class="field"><label>MÃ©tÃ©o</label><input class="input" id="dw" placeholder="Temps clair, 12Â°C"></div></div>`:''}
      <div class="field"><label>Constatations / Contexte</label><textarea class="input" id="dc" rows="4" placeholder="${docType==='memoire'?'Objet du marchÃ©, exigences, contraintes...':'DÃ©crivez les dÃ©sordres, localisations, mesures...'}"></textarea></div>
      <div class="field"><label>ğŸ“ Documents annexes</label><input type="file" id="dff" multiple style="display:none" onchange="shF('dff','dfl')"><div class="file-attach" onclick="document.getElementById('dff').click()">ğŸ“ Ajouter</div><div id="dfl"></div></div>
      <button class="btn btn-pri" onclick="genDoc()" style="margin-top:8px">ğŸ¤– GÃ©nÃ©rer avec l'IA</button>
      <div id="dout" style="margin-top:16px"></div>
    </div></div>`;
}

function genDoc(){
  const oid=document.getElementById('do')?.value,ouv=OUV.find(o=>o.id==oid);
  const date=document.getElementById('dd').value,red=document.getElementById('di2').value;
  const constat=document.getElementById('dc').value;
  const ctx=ouv?ouvCtx(ouv):'Aucun ouvrage sÃ©lectionnÃ©';
  let tpl='';
  if(docType==='pvid'){
    const fmt=document.getElementById('df')?.value||'routier';
    const moy=document.getElementById('dm')?.value||'',meteo=document.getElementById('dw')?.value||'';
    tpl=fmt==='routier'?`GÃ©nÃ¨re un PVID ROUTIER conforme ITSEOA/IQOA/CEREMA.\nSTRUCTURE: 1. PrÃ©sentation ouvrage + Conditions inspection 2. Plan de situation 3. Rappel derniÃ¨res conclusions 4. Constatations (4.1 Abords, 4.2 Superstructures: chaussÃ©e/joints/retenue/longrines/drainage, 4.3 Structure: intrados/culÃ©es/piles/AA) 5. Conclusion + Cotation IQOA. Annexes: Plan, RelevÃ© dÃ©fauts, Photos.`
    :`GÃ©nÃ¨re un PVID FERROVIAIRE SNCF conforme IN 1256.\nSTRUCTURE: Page garde, 1. Renseignements gÃ©nÃ©raux (repÃ©rage, caractÃ©ristiques, admin) 2. Historique 3. DÃ©roulÃ© visite (conditions, Ã©quipe, moyens, mÃ©tÃ©o) 4. Constatations (environnement, structure, Ã©tanchÃ©itÃ©, eaux) 5. SynthÃ¨se/Conclusions. Annexes: Photos, RelevÃ© avaries.`;
    tpl+=`\nMoyens: ${moy||'?'} | MÃ©tÃ©o: ${meteo||'?'}`;
  } else if(docType==='expertise'){
    tpl=`GÃ©nÃ¨re un COMPTE-RENDU D'EXPERTISE complet.\nSTRUCTURE: 1. Objet de l'expertise 2. Description de l'ouvrage 3. Historique des inspections et Ã©volution des dÃ©sordres 4. Constatations dÃ©taillÃ©es 5. Diagnostic (analyse causes, mÃ©canismes) 6. Ã‰valuation structurelle 7. PrÃ©conisations de rÃ©paration (avec normes) 8. PrioritÃ© d'intervention 9. Estimation budgÃ©taire 10. Conclusion`;
  } else {
    tpl=`GÃ©nÃ¨re un MÃ‰MOIRE TECHNIQUE pour appel d'offres.\nSTRUCTURE: 1. PrÃ©sentation entreprise 2. ComprÃ©hension mission 3. MÃ©thodologie dÃ©taillÃ©e 4. Moyens humains et matÃ©riels 5. Planning (Gantt) 6. PPSPS/SÃ©curitÃ© 7. PAQ/QualitÃ© 8. RÃ©fÃ©rences normatives`;
  }
  const full=AIP+'\n\n'+tpl+'\n\nDONNÃ‰ES PLATEFORME:\n'+ctx+'\nDate: '+date+' | RÃ©dacteur: '+(red||'?')+(constat?'\nCONSTATATIONS: '+constat:'')+'\n\nRÃ©dige le document complet, structurÃ©, professionnel. INTÃˆGRE l\'Ã©volution des dÃ©sordres s\'il y en a.';
  document.getElementById('dout').innerHTML=`<div class="prompt-box" id="docp">${esc(full)}</div>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-pri btn-sm" onclick="cpT('docp')">ğŸ“‹ Copier</button><span id="docps" class="fs12 c-ok"></span></div>
    ${aiInteractBox('docp','parseDocResp')}`;
}
function parseDocResp(id){
  const resp=document.getElementById(id).value.trim();if(!resp)return alert('Collez la rÃ©ponse');
  document.getElementById(id.replace('_resp','_status')).textContent='âœ… Document gÃ©nÃ©rÃ© ! Vous pouvez le copier et le mettre en forme.';
  // Show formatted response
  const zone=document.getElementById(id).parentElement;
  zone.insertAdjacentHTML('beforeend',`<div class="card" style="margin-top:16px;border-top:3px solid var(--ok)"><div class="card-title">ğŸ“„ Document gÃ©nÃ©rÃ©</div><div style="white-space:pre-line;font-size:13px;line-height:1.8">${esc(resp)}</div></div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PLANNING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mNT(){document.getElementById('mr').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)clM()"><div class="modal" style="max-width:500px">
  <div class="modal-title"><span>ğŸ“… Nouvelle tÃ¢che</span><button class="modal-close" onclick="clM()">âœ•</button></div>
  <div class="field"><label>Nom *</label><input class="input" id="tn" placeholder="PVID Pont de Pontorson"></div>
  <div class="grid-2"><div class="field"><label>CatÃ©gorie</label><select class="input" id="tc"><option>Inspection</option><option>Expertise</option><option>Travaux</option><option>Rapport</option><option>AO</option><option>SÃ©curitÃ©</option><option>RÃ©union</option><option>Autre</option></select></div>
    <div class="field"><label>DurÃ©e (jours)</label><input type="number" class="input" id="td" value="5" min="1"></div></div>
  <div class="field"><label>Jour de dÃ©but (J+0 = 1er fÃ©v.)</label><input type="number" class="input" id="ts2" value="0" min="0"></div>
  <div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-pri" onclick="sNT()">âœ… Ajouter</button><button class="btn btn-ghost" onclick="clM()">Annuler</button></div>
</div></div>`;}
function sNT(){const n=document.getElementById('tn').value.trim();if(!n)return alert('Nom obligatoire');const cc={'Inspection':'var(--pri)','Expertise':'var(--acc)','Travaux':'var(--err)','Rapport':'var(--ok)','AO':'#8B5CF6','SÃ©curitÃ©':'#EC4899','RÃ©union':'#06B6D4','Autre':'var(--txt-d)'};const c=document.getElementById('tc').value;TASKS.push({id:uid(),name:n,cat:c,start:parseInt(document.getElementById('ts2').value)||0,dur:parseInt(document.getElementById('td').value)||5,color:cc[c]||'var(--pri)'});clM();R();}
function rPlan(el){
  const total=60;const pills=`<div style="display:flex;gap:8px;margin-bottom:20px"><span class="pill ${planView==='gantt'?'active':''}" onclick="planView='gantt';R()">ğŸ“Š Gantt</span><span class="pill ${planView==='liste'?'active':''}" onclick="planView='liste';R()">ğŸ“‹ Liste</span></div>`;
  if(planView==='liste')return void(el.innerHTML=`<div class="fade-in">${pills}<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">ğŸ“… Planning</div><button class="btn btn-pri" onclick="mNT()">+ TÃ¢che</button></div>
    ${TASKS.length?`<table><thead><tr><th>TÃ¢che</th><th>Cat.</th><th>DÃ©but</th><th>DurÃ©e</th><th></th></tr></thead><tbody>${TASKS.map(t=>`<tr><td class="fw600">${t.name}</td><td><span class="tag" style="background:${t.color}20;color:${t.color}">${t.cat}</span></td><td class="fs12">J+${t.start}</td><td class="fs12">${t.dur}j</td><td><button class="btn btn-sm btn-ghost" style="color:var(--err)" onclick="TASKS=TASKS.filter(x=>x.id!==${t.id});R()">âœ•</button></td></tr>`).join('')}</tbody></table>`:'<div class="c-m" style="text-align:center;padding:32px">Aucune tÃ¢che.</div>'}</div></div>`);
  el.innerHTML=`<div class="fade-in">${pills}<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">ğŸ“… Planning</div><button class="btn btn-pri" onclick="mNT()">+ TÃ¢che</button></div>
    ${TASKS.length?`<div style="overflow-x:auto"><div style="display:grid;grid-template-columns:220px 1fr;min-width:800px"><div style="border-right:1px solid var(--brd)"><div style="height:32px;border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 12px;font-size:11px;color:var(--txt-m);font-weight:700;text-transform:uppercase">TÃ¢che</div>${TASKS.map(t=>`<div class="gantt-task">${t.name}</div>`).join('')}</div><div><div class="gantt-header">${['FÃ©v.','Mars','Avr.'].map(m=>`<div class="gantt-month">${m}</div>`).join('')}</div>${TASKS.map(t=>`<div class="gantt-row"><div class="gantt-bar" style="left:${(t.start/total)*100}%;width:${Math.max(t.dur/total*100,2)}%;background:${t.color}">${t.cat}</div></div>`).join('')}</div></div></div>`:'<div class="c-m" style="text-align:center;padding:32px">Aucune tÃ¢che.</div>'}
  </div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AI ASSISTANT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rAI(el){
  const ts=[{id:'general',l:'ğŸ’¬ GÃ©nÃ©ral'},{id:'pvid',l:'ğŸ“‹ PVID'},{id:'expertise',l:'ğŸ”¬ Expertise'},{id:'memoire',l:'ğŸ“ MÃ©moire'},{id:'normes',l:'ğŸ“š Normes'},{id:'planning',l:'ğŸ“… Planning'}];
  el.innerHTML=`<div class="fade-in"><div class="card" style="border-top:3px solid var(--pri)"><div class="card-title">ğŸ¤– GÃ©nÃ©rateur de prompts</div><div class="c-m fs13" style="margin-bottom:16px">SÃ©lectionnez, personnalisez, copiez dans votre IA. Le prompt intÃ¨gre automatiquement toutes les donnÃ©es et Ã©volutions de la plateforme.</div>
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">${ts.map(t=>`<span class="pill ${promptTopic===t.id?'active':''}" onclick="promptTopic='${t.id}';R()">${t.l}</span>`).join('')}</div>
    <div class="grid-2" style="margin-bottom:16px"><div class="field"><label>Ouvrage</label><select class="input" id="ao"><option value="">â€” Aucun â€”</option>${OUV.map(o=>`<option value="${o.id}">${o.nom}</option>`).join('')}</select></div><div class="field"><label>PrÃ©cisions</label><input class="input" id="ad" placeholder="Question ou dÃ©tail..."></div></div>
    <button class="btn btn-pri" onclick="genAI()">ğŸ”§ GÃ©nÃ©rer</button><div id="aout" style="margin-top:16px"></div>
  </div>${aiLinks()}</div>`;
}
function genAI(){
  const oid=document.getElementById('ao')?.value,det=document.getElementById('ad')?.value.trim()||'',ouv=oid?OUV.find(o=>o.id==oid):null;
  let ctx='';if(ouv)ctx='\n'+ouvCtx(ouv);
  const m={general:det||'[Votre question]',pvid:'RÃ©dige un PVID complet.'+(det?' '+det:''),expertise:'Expertise pathologique.'+(det?' '+det:''),memoire:'MÃ©moire technique AO.'+(det?' '+det:''),normes:'Normes applicables ?'+(det?' '+det:''),planning:'Planning travaux.'+(det?' '+det:'')};
  const full=AIP+ctx+'\n\nMISSION: '+m[promptTopic];
  document.getElementById('aout').innerHTML=`<div class="prompt-box" id="ait">${esc(full)}</div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-pri btn-sm" onclick="cpT('ait')">ğŸ“‹ Copier</button><span id="aits" class="fs12 c-ok"></span></div>
    ${aiInteractBox('ait','parseAIResp')}`;
}
function parseAIResp(id){
  const resp=document.getElementById(id).value.trim();if(!resp)return alert('Collez la rÃ©ponse');
  document.getElementById(id.replace('_resp','_status')).textContent='âœ… RÃ©ponse intÃ©grÃ©e !';
  const zone=document.getElementById(id).parentElement;
  zone.insertAdjacentHTML('beforeend',`<div class="card" style="margin-top:16px;border-top:3px solid var(--ok)"><div class="card-title">ğŸ“„ RÃ©ponse IA</div><div style="white-space:pre-line;font-size:13px;line-height:1.8">${esc(resp)}</div></div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bSB();nav('dashboard');
</script>
</body>
</html>
