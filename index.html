<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
<meta name="description" content="OA Expert â€” Plateforme IA Ouvrages d'Art â€” Inspections, RÃ©parations, Normes">
<title>OA Expert â€” Plateforme IA Ouvrages d'Art</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%233B82F6'/><text x='16' y='22' text-anchor='middle' fill='white' font-size='16' font-weight='900' font-family='sans-serif'>OA</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
:root {
  --bg:#0B1120;--sidebar:#0F1729;--card:#141D2F;--card-h:#1A2540;
  --brd:#1E2A45;--brd-l:#2A3A5C;
  --pri:#3B82F6;--pri-d:#2563EB;--pri-g:rgba(59,130,246,0.15);
  --acc:#F59E0B;--acc-d:#D97706;--acc-g:rgba(245,158,11,0.12);
  --err:#EF4444;--err-g:rgba(239,68,68,0.12);
  --ok:#10B981;--ok-g:rgba(16,185,129,0.12);
  --txt:#E2E8F0;--txt-m:#9DB1D0;--txt-d:#5E7499;
  --ff:'DM Sans','Segoe UI',sans-serif;
  --mono:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;margin:0;padding:0;border:0;width:100%}
body{font-family:var(--ff);background:var(--bg);color:var(--txt)}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--brd-l)}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238B9DC3' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px!important}
select option{background:var(--card);color:var(--txt)}
input:focus,select:focus{border-color:var(--pri)!important;box-shadow:0 0 0 3px var(--pri-g);outline:none}
tr{transition:background .15s}
button{cursor:pointer;font-family:var(--ff)}
a{color:var(--pri);text-decoration:none}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
#app{height:100vh;width:100vw}
.app-layout{display:flex;height:100%}
.sidebar{width:256px;min-width:256px;background:var(--sidebar);border-right:1px solid var(--brd);display:flex;flex-direction:column;transition:width .3s,min-width .3s}
.sidebar.collapsed{width:66px;min-width:66px}
.sidebar-logo{padding:20px 18px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:12px;cursor:pointer}
.collapsed .sidebar-logo{padding:20px 14px;justify-content:center}
.sidebar-logo-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--pri),var(--acc));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;color:#fff;flex-shrink:0}
.sidebar-logo-text{overflow:hidden;white-space:nowrap}
.collapsed .sidebar-logo-text{display:none}
.sidebar-nav{flex:1;padding-top:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 18px;cursor:pointer;font-size:13.5px;color:var(--txt-m);border-left:3px solid transparent;transition:all .2s;white-space:nowrap;overflow:hidden;min-height:36px}
.nav-item:hover{color:var(--txt);background:rgba(255,255,255,0.03)}
.nav-item.active{color:var(--pri);background:var(--pri-g);border-left-color:var(--pri);font-weight:600}
.nav-item .nav-icon{flex-shrink:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:16px}
.collapsed .nav-item{padding:10px 22px;justify-content:center}
.collapsed .nav-item span:not(.nav-icon){display:none}
.nav-sep{height:1px;background:var(--brd);margin:8px 18px}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:14px 28px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;background:var(--sidebar)}
.main-header h1{font-size:18px;font-weight:800;letter-spacing:-.3px}
.main-header .sub{font-size:12px;color:var(--txt-m);margin-top:2px}
.main-content{flex:1;overflow:auto;padding:28px}

.card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:20px;margin-bottom:16px}
.card-title{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.stat-num{font-size:28px;font-weight:800;font-family:var(--mono);line-height:1}
.stat-label{font-size:11px;color:var(--txt-m);text-transform:uppercase;letter-spacing:1px;margin-top:6px;font-weight:600}
.stat-sub{font-size:11px;color:var(--txt-d);margin-top:4px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-21{display:grid;grid-template-columns:2fr 1fr;gap:16px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
th{text-align:left;padding:10px 14px;border-bottom:1px solid var(--brd);color:var(--txt-m);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.8px}
td{padding:12px 14px;border-bottom:1px solid var(--brd)}
tr.clickable{cursor:pointer}tr.clickable:hover{background:var(--card-h)}
.mono{font-family:var(--mono)}.fw600{font-weight:600}.fw700{font-weight:700}.fs12{font-size:12px}.fs11{font-size:11px}
.c-m{color:var(--txt-m)}.c-d{color:var(--txt-d)}.c-pri{color:var(--pri)}.c-acc{color:var(--acc)}.c-err{color:var(--err)}.c-ok{color:var(--ok)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;border:none;font-size:13px;font-weight:600;transition:all .2s;font-family:var(--ff);min-height:36px}
.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--pri-d);box-shadow:0 4px 14px rgba(59,130,246,0.25)}
.btn-acc{background:var(--acc);color:#fff}.btn-err{background:var(--err);color:#fff}
.btn-ghost{background:transparent;color:var(--txt-m);border:1px solid var(--brd)}.btn-ghost:hover{border-color:var(--brd-l);color:var(--txt)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px}
.pill{display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;border:1px solid var(--brd);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--txt-m);background:transparent;min-height:36px}
.pill:hover{border-color:var(--brd-l);color:var(--txt)}.pill.active{border-color:var(--pri);background:var(--pri-g);color:var(--pri)}
.badge{display:inline-flex;align-items:center;justify-content:center;padding:2px 10px;border-radius:6px;font-size:12px;font-weight:700;letter-spacing:.5px;min-width:32px;font-family:var(--mono)}
.badge-1{background:#065F46;color:#6EE7B7}.badge-2{background:#1E3A5F;color:#93C5FD}.badge-2e{background:#78350F;color:#FCD34D}.badge-3{background:#7C2D12;color:#FDBA74}.badge-3u{background:#7F1D1D;color:#FCA5A5}
.input{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:9px 14px;color:var(--txt);font-size:13px;font-family:var(--ff);outline:none;width:100%;transition:border .2s}
.tag{font-size:11px;padding:3px 10px;border-radius:6px;font-weight:600;display:inline-block}
.tag-pri{background:var(--pri-g);color:var(--pri)}.tag-acc{background:var(--acc-g);color:var(--acc)}.tag-ok{background:var(--ok-g);color:var(--ok)}.tag-err{background:var(--err-g);color:var(--err)}
.drop-zone{border:2px dashed var(--brd);border-radius:12px;padding:48px;text-align:center;background:var(--bg);cursor:pointer;transition:border-color .2s}.drop-zone:hover{border-color:var(--pri)}
.toggle{width:40px;height:22px;border-radius:11px;position:relative;cursor:pointer;transition:background .2s;min-height:22px}
.toggle.on{background:var(--ok)}.toggle.off{background:var(--brd)}
.toggle-knob{width:18px;height:18px;border-radius:9px;background:#fff;position:absolute;top:2px;transition:left .2s}
.toggle.on .toggle-knob{left:20px}.toggle.off .toggle-knob{left:2px}
.gantt-header{display:flex;border-bottom:1px solid var(--brd);height:32px}
.gantt-month{flex:1;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--txt-m);font-weight:700;border-right:1px solid var(--brd)}
.gantt-row{height:36px;border-bottom:1px solid var(--brd);position:relative;display:flex;align-items:center}
.gantt-bar{position:absolute;height:22px;border-radius:6px;display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;color:#fff;overflow:hidden;white-space:nowrap;opacity:.85}
.gantt-task{height:36px;border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 12px;font-size:12px;font-weight:500;border-right:1px solid var(--brd);min-width:220px}

/* â”€â”€â”€ PROMPT GENERATOR â”€â”€â”€ */
.prompt-box{background:#070b14;border:1px solid var(--brd);border-radius:10px;padding:16px 16px 16px 16px;font-family:var(--mono);font-size:12px;line-height:1.7;color:var(--txt-m);white-space:pre-wrap;max-height:400px;overflow:auto;position:relative;cursor:text;user-select:all}
.prompt-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;align-items:center}
.copy-btn{padding:8px 18px;background:var(--pri);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--ff);transition:all .2s}
.copy-btn:hover{background:var(--pri-d)}.copy-btn.copied{background:var(--ok)}
.ai-link{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--brd);color:var(--txt);text-decoration:none;transition:all .2s}
.ai-link:hover{border-color:var(--pri);background:var(--pri-g);color:var(--pri)}
.chat-container{display:flex;flex-direction:column;height:calc(100vh - 130px)}

/* â”€â”€â”€ ACCESSIBILITY â”€â”€â”€ */
.skip-nav{position:absolute;top:-50px;left:0;background:var(--pri);color:#fff;padding:12px 24px;z-index:10000;font-weight:700;font-size:14px;border-radius:0 0 8px 0;transition:top .2s}
.skip-nav:focus{top:0}
*:focus-visible{outline:2px solid var(--pri);outline-offset:2px;border-radius:4px}
*:focus:not(:focus-visible){outline:none}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
@media(prefers-reduced-motion:reduce){*{animation:none!important;transition-duration:0.01ms!important}}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .4s ease-out}
@media(max-width:900px){
  .sidebar{width:66px;min-width:66px}
  .sidebar .sidebar-logo-text,.sidebar .nav-item span:not(.nav-icon){display:none}
  .sidebar .nav-item{padding:10px 22px;justify-content:center}
  .sidebar .sidebar-logo{padding:20px 14px;justify-content:center}
  .grid-4{grid-template-columns:repeat(2,1fr)}.grid-2,.grid-21{grid-template-columns:1fr}
}
@media(max-height:600px){.main-content{padding:16px}.grid-4{grid-template-columns:repeat(2,1fr)}.stat-num{font-size:22px}}
</style>
</head>
<body>
<a href="#main-content" class="skip-nav">Aller au contenu principal</a>
<div id="app">
<div class="app-layout">
  <nav class="sidebar" id="sidebar" aria-label="Navigation principale">
    <div class="sidebar-logo" onclick="toggleSidebar()" role="button" tabindex="0" aria-label="RÃ©duire ou Ã©tendre le menu" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSidebar()}">
      <div class="sidebar-logo-icon" aria-hidden="true">OA</div>
      <div class="sidebar-logo-text">
        <div style="font-size:16px;font-weight:800;letter-spacing:-.5px">OA Expert</div>
        <div style="font-size:10px;color:var(--txt-m);font-weight:600;letter-spacing:1.5px;text-transform:uppercase">IA â€¢ Ouvrages d'Art</div>
      </div>
    </div>
    <div class="sidebar-nav" id="sidebar-nav" role="menubar" aria-label="Modules"></div>
    <div style="padding:14px 18px;border-top:1px solid var(--brd);font-size:10px;color:var(--txt-d);text-align:center">OA Expert v3.0 â€” AccÃ¨s libre</div>
  </nav>
  <main class="main-area" role="main">
    <header class="main-header" role="banner">
      <div><h1 id="page-title">Tableau de bord</h1><div class="sub" id="page-sub"></div></div>
      <div style="font-size:11px;color:var(--ok);font-weight:600;display:flex;align-items:center;gap:4px">
        <span style="width:7px;height:7px;border-radius:4px;background:var(--ok);display:inline-block" aria-hidden="true"></span> En ligne
      </div>
    </header>
    <div class="main-content" id="main-content" role="region" aria-label="Contenu principal"></div>
  </main>
</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeModule = "dashboard";
let clientFilter = "all";
let selectedOuvrage = null;
let selectedDesordre = null;
let normsSearch = "";
let normsOrg = "all";
let docType = "inspection";
let planningView = "gantt";
let promptTopic = "general";

const CLIENTS = [
  {id:"ferroviaire",label:"Ferroviaire",icon:"ğŸš†",color:"#3B82F6",norms:["SNCF RÃ©seau","IMGC","ITSEOA"]},
  {id:"routier",label:"Routier",icon:"ğŸ›£ï¸",color:"#10B981",norms:["CEREMA","SETRA","LCPC","ITSEOA"]},
  {id:"fluvial",label:"Fluvial / Maritime",icon:"âš“",color:"#8B5CF6",norms:["CEREMA","CETU","SETRA"]},
  {id:"autre",label:"Autre / PrivÃ©",icon:"ğŸ—ï¸",color:"#F59E0B",norms:["CEREMA","LCPC"]},
];

const NORMS_DB = [
  {org:"ITSEOA",ref:"Fascicule 0",title:"Dispositions gÃ©nÃ©rales applicables Ã  tous les ouvrages",domain:"Surveillance"},
  {org:"ITSEOA",ref:"Fascicule 2",title:"Ouvrages en maÃ§onnerie",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 3",title:"Ouvrages en bÃ©ton â€“ Fondations",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 10",title:"Ponts et viaducs Ã  tablier en poutrelles enrobÃ©es",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 11",title:"Ponts mÃ©talliques",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 12",title:"Ponts Ã  haubans et ponts suspendus",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 13",title:"Ponts Ã  tablier en bois",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 21",title:"Ã‰quipements : appareils d'appui",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 32",title:"Murs de soutÃ¨nement",domain:"Inspection"},
  {org:"ITSEOA",ref:"Fascicule 40",title:"Tunnels â€“ GÃ©nie civil et Ã©quipements",domain:"Inspection"},
  {org:"CEREMA",ref:"Guide IQOA",title:"Image QualitÃ© des Ouvrages d'Art â€“ Ponts",domain:"Cotation"},
  {org:"CEREMA",ref:"Guide IQOA Murs",title:"Image QualitÃ© des Ouvrages d'Art â€“ Murs",domain:"Cotation"},
  {org:"CEREMA",ref:"Guide technique",title:"Protection des ouvrages mÃ©talliques contre la corrosion",domain:"Protection"},
  {org:"CEREMA",ref:"Guide technique",title:"Dalles orthotropes â€“ Conception et dimensionnement",domain:"Conception"},
  {org:"CEREMA",ref:"Guide mÃ©thodologique",title:"Surveillance et entretien courant des OA routiers",domain:"Surveillance"},
  {org:"CEREMA",ref:"Guide technique",title:"RÃ©sistance Ã  la fatigue â€“ Ponts mÃ©talliques et mixtes",domain:"Calcul"},
  {org:"SETRA",ref:"Guide technique",title:"Appareils d'appui en Ã©lastomÃ¨re frettÃ©",domain:"Appareils d'appui"},
  {org:"SETRA",ref:"Guide technique",title:"PrÃ©contrainte extÃ©rieure",domain:"RÃ©paration"},
  {org:"SETRA",ref:"Guide Joints",title:"Joints de chaussÃ©e des ponts routes",domain:"Ã‰quipements"},
  {org:"LCPC",ref:"Guide technique",title:"BÃ©tons projetÃ©s â€“ Guide de mise en Å“uvre",domain:"RÃ©paration"},
  {org:"LCPC",ref:"Guide LCPC",title:"Diagnostic et aide Ã  la dÃ©cision â€“ Ouvrages en bÃ©ton",domain:"Diagnostic"},
  {org:"LCPC",ref:"MÃ©thode d'essai",title:"Auscultation des ouvrages par mÃ©thodes non destructives",domain:"CND"},
  {org:"CETU",ref:"Guide technique",title:"Dossier pilote des tunnels â€“ GÃ©nie civil",domain:"Tunnels"},
  {org:"CETU",ref:"Fascicule",title:"Diagnostic des tunnels â€“ Guide d'inspection dÃ©taillÃ©e",domain:"Tunnels"},
  {org:"SNCF RÃ©seau",ref:"IN 1256",title:"Surveillance et entretien des ouvrages d'art",domain:"Surveillance"},
  {org:"SNCF RÃ©seau",ref:"IN 1260",title:"SystÃ¨me de cotation des dÃ©sordres des OA",domain:"Cotation"},
  {org:"SNCF RÃ©seau",ref:"IN 1130",title:"RÃ¨gles de sÃ©curitÃ© pour les travaux ferroviaires",domain:"SÃ©curitÃ©"},
  {org:"SNCF RÃ©seau",ref:"IN 2089",title:"Pose de la voie sur les ouvrages d'art",domain:"Voie"},
  {org:"SNCF RÃ©seau",ref:"IN 3937",title:"Formation Agent HabilitÃ© surveillance OA",domain:"Formation"},
  {org:"SNCF RÃ©seau",ref:"IN 7012 (IN 00035)",title:"RÃ©parations des Ponts MÃ©talliques (RPM)",domain:"RÃ©paration"},
  {org:"SNCF RÃ©seau",ref:"IN 00036",title:"Protection anticorrosion des ouvrages mÃ©talliques",domain:"Protection"},
  {org:"SNCF RÃ©seau",ref:"MT 1253",title:"RÃ¨gles de surveillance des OA et constructions apparentÃ©es",domain:"Surveillance"},
  {org:"IMGC",ref:"Guide IMGC",title:"Instruction MinistÃ©rielle sur la Gestion du patrimoine",domain:"Gestion"},
  {org:"STRRES",ref:"RECO NÂ°4",title:"RÃ©paration et renforcement des structures â€“ Guide",domain:"RÃ©paration"},
  {org:"NF EN",ref:"EN 1090-2",title:"ExÃ©cution des structures en acier â€“ Exigences techniques",domain:"ExÃ©cution"},
  {org:"NF EN",ref:"EN 1504",title:"Produits et systÃ¨mes pour protection et rÃ©paration du bÃ©ton",domain:"RÃ©paration"},
  {org:"NF EN",ref:"EN 1991 (EC1)",title:"Actions sur les structures",domain:"Calcul"},
  {org:"NF EN",ref:"EN 1992 (EC2)",title:"Calcul des structures en bÃ©ton",domain:"Calcul"},
  {org:"NF EN",ref:"EN 1993 (EC3)",title:"Calcul des structures en acier",domain:"Calcul"},
  {org:"NF EN",ref:"ISO 12944",title:"Anticorrosion des structures en acier par systÃ¨mes de peinture",domain:"Protection"},
  {org:"NF EN",ref:"ISO 8501-1",title:"PrÃ©paration des subjectiles d'acier â€“ Ã‰valuation visuelle",domain:"Protection"},
  {org:"CCTG",ref:"Fascicule 56",title:"Protection des ouvrages mÃ©talliques contre la corrosion",domain:"Protection"},
  {org:"CCTG",ref:"Fascicule 65",title:"ExÃ©cution des ouvrages de gÃ©nie civil en bÃ©ton armÃ©",domain:"ExÃ©cution"},
  {org:"CCTG",ref:"Fascicule 66",title:"ExÃ©cution des ponts et ouvrages mÃ©talliques",domain:"ExÃ©cution"},
];

const OUVRAGES = [
  {id:1,nom:"Pont de Pontorson (PK 342+120)",type:"Pont-rail mÃ©tallique",client:"ferroviaire",iqoa:"3U",lastInsp:"2025-11-15",avaries:12},
  {id:2,nom:"Viaduc de la Sioule (A89)",type:"Viaduc routier mixte",client:"routier",iqoa:"2E",lastInsp:"2025-09-20",avaries:8},
  {id:3,nom:"Pont Long BiÃªn (HanoÃ¯)",type:"Pont mÃ©tallique historique",client:"autre",iqoa:"3U",lastInsp:"2025-06-10",avaries:47},
  {id:4,nom:"Passerelle de Rosny-sous-Bois",type:"Passerelle mÃ©tallique",client:"ferroviaire",iqoa:"2",lastInsp:"2025-08-05",avaries:6},
  {id:5,nom:"Pont de Neufchelles (PK 68+450)",type:"Pont-rail bÃ©ton",client:"ferroviaire",iqoa:"2E",lastInsp:"2025-03-22",avaries:4},
];

const DESORDRES = [
  {id:1,ouvrage:1,element:"Poutre principale PG",type:"Fissure de fatigue",severite:"3U",date:"2025-11-15",evolution:[{date:"2023-06",val:0.2},{date:"2024-01",val:0.35},{date:"2024-06",val:0.5},{date:"2025-01",val:0.7},{date:"2025-11",val:1.02}]},
  {id:2,ouvrage:1,element:"Rivets corniÃ¨re d'Ã¢me",type:"Corrosion avancÃ©e",severite:"2E",date:"2025-11-15",evolution:[{date:"2023-06",val:15},{date:"2024-06",val:22},{date:"2025-11",val:35}]},
  {id:3,ouvrage:2,element:"Tablier â€“ dalle BA",type:"Ã‰caillage bÃ©ton",severite:"2",date:"2025-09-20",evolution:[{date:"2024-03",val:0.5},{date:"2025-09",val:1.2}]},
  {id:4,ouvrage:3,element:"TravÃ©e 5 â€“ poutre",type:"Flambement local",severite:"3U",date:"2025-06-10",evolution:[{date:"2024-01",val:5},{date:"2025-06",val:12}]},
  {id:5,ouvrage:4,element:"Garde-corps",type:"DÃ©formation",severite:"2E",date:"2025-08-05",evolution:[{date:"2025-01",val:3},{date:"2025-08",val:8}]},
];

const MODULES = [
  {id:"dashboard",label:"Tableau de bord",icon:"ğŸ“Š",sub:"Vue d'ensemble du patrimoine et des actions en cours"},
  {id:"ouvrages",label:"Ouvrages",icon:"ğŸŒ‰",sub:"Gestion du patrimoine d'ouvrages d'art"},
  {id:"inspections",label:"Inspections",icon:"ğŸ”",sub:"Campagnes d'inspection et relevÃ©s de dÃ©sordres"},
  {id:"desordres",label:"DÃ©sordres",icon:"âš ï¸",sub:"Registre et suivi de l'Ã©volution des avaries"},
  {id:"normes",label:"Base normative",icon:"ğŸ“š",sub:NORMS_DB.length+" rÃ©fÃ©rences : CEREMA, SNCF, ITSEOA, SETRA, LCPC, CETU, IMGC"},
  {id:"documents",label:"Documents",icon:"ğŸ“„",sub:"GÃ©nÃ©ration IA : PVID, expertises, mÃ©moires techniques"},
  {id:"planning",label:"Planning",icon:"ğŸ“…",sub:"Planning d'inspections, travaux et Ã©tudes"},
  {id:"ai",label:"Assistant IA",icon:"ğŸ¤–",sub:"GÃ©nÃ©rateur de prompts â€” Copilot, ChatGPT, Gemini, Claude..."},
  {id:"sep1",sep:true},
  {id:"sharepoint",label:"SharePoint",icon:"â˜ï¸",sub:"Synchronisation et publication automatique"},
  {id:"collab",label:"Collaboration",icon:"ğŸ‘¥",sub:"Travail collaboratif en temps rÃ©el"},
];

const AI_SYSTEM_PROMPT = `Tu es OA Expert IA, un assistant spÃ©cialisÃ© de haut niveau en inspection, maintenance et rÃ©paration d'ouvrages d'art (ponts, viaducs, passerelles, tunnels, murs de soutÃ¨nement).

DOMAINES D'EXPERTISE :
- Inspection dÃ©taillÃ©e (PVID, IDP, VST) selon ITSEOA et IN 1256 SNCF RÃ©seau
- Cotation IQOA (routier) et IN 1260 (ferroviaire)
- Pathologies : fissuration, corrosion, fatigue, flambement, Ã©caillage bÃ©ton
- RÃ©paration : rivetage Ã  chaud, remplacement appareils d'appui, renforcement, bÃ©ton projetÃ©, prÃ©contrainte extÃ©rieure
- Protection anticorrosion selon ISO 12944, Fascicule 56 CCTG, IN 00036 SNCF
- Calculs selon Eurocodes (EN 1991, 1992, 1993)
- RÃ©daction de mÃ©moires techniques pour appels d'offres

BASE NORMATIVE :
ITSEOA (Fascicules 0-40), CEREMA (IQOA, protection, fatigue), SNCF RÃ©seau (IN 1256, 1260, 1130, 7012/00035, 00036), SETRA (appareils d'appui, prÃ©contrainte, joints), LCPC (bÃ©ton projetÃ©, diagnostic, CND), CETU (tunnels), IMGC, STRRES RECO NÂ°4, Eurocodes EN 1090-2/1504/1991-1993, ISO 12944/8501-1, CCTG Fascicules 56/65/66.

RÃˆGLES : RÃ©ponds en franÃ§ais technique. Cite les normes applicables. Structure clairement. Adapte le rÃ©fÃ©rentiel au client (ferroviaire=SNCF/IMGC, routier=CEREMA/SETRA/ITSEOA, tunnels=CETU).`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }

function buildSidebar() {
  const nav = document.getElementById('sidebar-nav');
  nav.innerHTML = '';
  MODULES.forEach(m => {
    if (m.sep) { nav.innerHTML += '<div class="nav-sep" role="separator"></div>'; return; }
    nav.innerHTML += `<div class="nav-item ${activeModule===m.id?'active':''}" onclick="navigate('${m.id}')" title="${m.label}" role="menuitem" tabindex="0" aria-current="${activeModule===m.id?'page':'false'}" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();navigate('${m.id}')}">
      <span class="nav-icon" aria-hidden="true">${m.icon}</span><span>${m.label}</span>
    </div>`;
  });
}

function navigate(mod) {
  activeModule = mod; selectedOuvrage = null; selectedDesordre = null;
  const m = MODULES.find(x => x.id === mod);
  document.getElementById('page-title').textContent = m?.label || '';
  document.getElementById('page-sub').textContent = m?.sub || '';
  buildSidebar(); renderModule();
}

function iqoaBadge(code) {
  const cls = {'1':'badge-1','2':'badge-2','2E':'badge-2e','3':'badge-3','3U':'badge-3u'}[code]||'badge-2';
  return `<span class="badge ${cls}">${code}</span>`;
}
function clientIcon(id) { return CLIENTS.find(c=>c.id===id)?.icon||'ğŸ—ï¸'; }
function clientLabel(id) { return CLIENTS.find(c=>c.id===id)?.label||''; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModule() {
  const el = document.getElementById('main-content');
  switch(activeModule) {
    case 'dashboard': el.innerHTML = renderDashboard(); break;
    case 'ouvrages': el.innerHTML = renderOuvrages(); break;
    case 'inspections': el.innerHTML = renderInspections(); break;
    case 'desordres': el.innerHTML = renderDesordres(); break;
    case 'normes': el.innerHTML = renderNormes(); attachNormsEvents(); break;
    case 'documents': el.innerHTML = renderDocuments(); break;
    case 'planning': el.innerHTML = renderPlanning(); break;
    case 'ai': el.innerHTML = renderAI(); break;
    case 'sharepoint': el.innerHTML = renderSharepoint(); break;
    case 'collab': el.innerHTML = renderCollab(); break;
    default: el.innerHTML = renderDashboard();
  }
  // Accessibility: make clickable rows keyboard-navigable
  document.querySelectorAll('tr.clickable').forEach(tr => {
    tr.setAttribute('tabindex','0');
    tr.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();tr.click()}});
  });
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€
function renderDashboard() {
  const urgent = OUVRAGES.filter(o=>['3U','2E'].includes(o.iqoa));
  return `<div class="fade-in">
  <div class="grid-4" style="margin-bottom:24px">
    ${[{l:"Ouvrages suivis",v:OUVRAGES.length,c:"var(--pri)",s:CLIENTS.length+" secteurs"},
       {l:"DÃ©sordres actifs",v:DESORDRES.length,c:"var(--err)",s:DESORDRES.filter(d=>d.severite==='3U').length+" urgences 3U"},
       {l:"Inspections planifiÃ©es",v:8,c:"var(--acc)",s:"Q1 2026"},
       {l:"Documents gÃ©nÃ©rÃ©s",v:23,c:"var(--ok)",s:"ce trimestre"}
    ].map(s=>`<div class="card" style="border-top:3px solid ${s.c}">
      <div class="stat-num" style="color:${s.c}">${s.v}</div>
      <div class="stat-label">${s.l}</div><div class="stat-sub">${s.s}</div>
    </div>`).join('')}
  </div>
  <div class="grid-21">
    <div class="card"><div class="card-title">ğŸš¨ Ouvrages critiques</div>
      <table><thead><tr><th>Ouvrage</th><th>Type</th><th>Client</th><th>IQOA</th><th>Avaries</th></tr></thead>
      <tbody>${urgent.map(o=>`<tr class="clickable" onclick="selectedOuvrage=${o.id};activeModule='ouvrages';navigate('ouvrages');viewOuvrage(${o.id})">
        <td class="fw600">${o.nom}</td><td class="c-m fs12">${o.type}</td><td>${clientIcon(o.client)}</td><td>${iqoaBadge(o.iqoa)}</td>
        <td class="mono fw600 ${o.avaries>10?'c-err':''}">${o.avaries}</td></tr>`).join('')}</tbody></table>
    </div>
    <div class="card"><div class="card-title">ğŸ“… Prochaines Ã©chÃ©ances</div>
      ${[{d:"18 fÃ©v.",l:"PVID Pont Pontorson",t:"Inspection",c:"var(--pri)"},{d:"25 fÃ©v.",l:"Rapport expertise Sioule",t:"Document",c:"var(--acc)"},{d:"03 mars",l:"COTECH Long BiÃªn",t:"RÃ©union",c:"var(--ok)"},{d:"10 mars",l:"Remise mÃ©moire AO Ligne 4",t:"AO",c:"#8B5CF6"}
      ].map((e,i)=>`<div style="display:flex;gap:14px;align-items:center;padding:10px 0;${i<3?'border-bottom:1px solid var(--brd)':''}">
        <div class="mono fw700 c-acc fs12" style="min-width:56px">${e.d}</div>
        <div style="flex:1"><div style="font-size:13px;font-weight:500">${e.l}</div>
        <span class="tag" style="background:${e.c}18;color:${e.c}">${e.t}</span></div></div>`).join('')}
    </div>
  </div></div>`;
}

// â”€â”€â”€ OUVRAGES â”€â”€â”€
function viewOuvrage(id) { selectedOuvrage=id; document.getElementById('main-content').innerHTML=renderOuvrages(); }
function renderOuvrages() {
  const filtered = clientFilter==='all' ? OUVRAGES : OUVRAGES.filter(o=>o.client===clientFilter);
  let pills = `<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap" role="tablist">
    <span class="pill ${clientFilter==='all'?'active':''}" onclick="clientFilter='all';renderModule()" role="tab" tabindex="0" onkeydown="if(event.key==='Enter'){clientFilter='all';renderModule()}">ğŸ—ï¸ Tous</span>
    ${CLIENTS.map(c=>`<span class="pill ${clientFilter===c.id?'active':''}" onclick="clientFilter='${c.id}';renderModule()" role="tab" tabindex="0" onkeydown="if(event.key==='Enter'){clientFilter='${c.id}';renderModule()}">${c.icon} ${c.label}</span>`).join('')}</div>`;
  if (selectedOuvrage) {
    const o = OUVRAGES.find(x=>x.id===selectedOuvrage); if (!o) { selectedOuvrage=null; return renderOuvrages(); }
    const cl = CLIENTS.find(c=>c.id===o.client), des = DESORDRES.filter(d=>d.ouvrage===o.id);
    return `<div class="fade-in"><div style="cursor:pointer;color:var(--txt-m);font-size:13px;margin-bottom:20px" onclick="selectedOuvrage=null;renderModule()" tabindex="0" role="link" onkeydown="if(event.key==='Enter'){selectedOuvrage=null;renderModule()}">â† Retour</div>
      <div class="card"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div style="font-size:20px;font-weight:800;margin-bottom:6px">${o.nom}</div><div class="c-m">${o.type} â€¢ ${cl?.label}</div></div>${iqoaBadge(o.iqoa)}</div>
        <div class="grid-3" style="margin-top:20px">${[['DerniÃ¨re inspection',o.lastInsp],['Avaries actives',o.avaries],['Normes applicables',cl?.norms.join(', ')]].map(([l,v])=>`<div style="padding:14px;background:var(--bg);border-radius:8px;border:1px solid var(--brd)"><div class="fs11 c-m fw600" style="text-transform:uppercase;letter-spacing:.8px">${l}</div><div style="font-size:15px;font-weight:600;margin-top:4px">${v}</div></div>`).join('')}</div>
      </div>
      <div class="card"><div class="card-title">ğŸš¨ DÃ©sordres associÃ©s</div>
        <table><thead><tr><th>Ã‰lÃ©ment</th><th>Type</th><th>SÃ©vÃ©ritÃ©</th><th>Date</th><th>Ã‰volution</th></tr></thead>
        <tbody>${des.map(d=>`<tr class="clickable" onclick="selectedDesordre=${d.id};navigate('desordres');viewDesordre(${d.id})"><td class="fw600">${d.element}</td><td class="c-m">${d.type}</td><td>${iqoaBadge(d.severite)}</td><td class="mono fs12">${d.date}</td><td class="fs12 c-err">â†— ${d.evolution.length} mesures</td></tr>`).join('')}</tbody></table>
      </div></div>`;
  }
  return `<div class="fade-in">${pills}<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">Patrimoine (${filtered.length})</div><button class="btn btn-pri">+ Nouvel ouvrage</button></div>
    <table><thead><tr><th>Ouvrage</th><th>Type</th><th>Client</th><th>IQOA</th><th>Inspection</th><th>Avaries</th></tr></thead>
    <tbody>${filtered.map(o=>`<tr class="clickable" onclick="viewOuvrage(${o.id})"><td class="fw600">${o.nom}</td><td class="c-m fs12">${o.type}</td><td>${clientIcon(o.client)} <span class="c-m fs12">${clientLabel(o.client)}</span></td><td>${iqoaBadge(o.iqoa)}</td><td class="mono fs12">${o.lastInsp}</td><td class="mono fw600 ${o.avaries>10?'c-err':''}">${o.avaries}</td></tr>`).join('')}</tbody></table>
  </div></div>`;
}

// â”€â”€â”€ INSPECTIONS â”€â”€â”€
function renderInspections() {
  const camps = [
    {ref:"INS-2025-042",ouv:"Pont de Pontorson",type:"PVID",date:"2025-11-15",insp:"D. Lhote",status:"âœ… FinalisÃ©"},
    {ref:"INS-2025-038",ouv:"Viaduc de la Sioule",type:"IDP",date:"2025-09-20",insp:"L. Aurier",status:"âœ… FinalisÃ©"},
    {ref:"INS-2025-035",ouv:"Pont Long BiÃªn",type:"Expertise",date:"2025-06-10",insp:"D. Lhote",status:"âœ… FinalisÃ©"},
    {ref:"INS-2026-001",ouv:"Pont de Pontorson",type:"PVID",date:"2026-02-18",insp:"D. Lhote",status:"ğŸ“‹ PlanifiÃ©e"},
    {ref:"INS-2026-002",ouv:"Passerelle Rosny",type:"VST",date:"2026-03-05",insp:"H. Ouabdel Moumen",status:"ğŸ“‹ PlanifiÃ©e"},
  ];
  return `<div class="fade-in"><div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">ğŸ” Campagnes d'inspection</div><button class="btn btn-pri">+ Nouvelle campagne</button></div>
    <table><thead><tr><th>RÃ©f.</th><th>Ouvrage</th><th>Type</th><th>Date</th><th>Inspecteur</th><th>Statut</th></tr></thead>
    <tbody>${camps.map(c=>`<tr class="clickable"><td class="mono fs12 fw700 c-acc">${c.ref}</td><td class="fw600">${c.ouv}</td><td><span class="tag tag-pri">${c.type}</span></td><td class="mono fs12">${c.date}</td><td>${c.insp}</td><td class="fs12">${c.status}</td></tr>`).join('')}</tbody></table>
  </div></div>`;
}

// â”€â”€â”€ DESORDRES â”€â”€â”€
function viewDesordre(id) { selectedDesordre=id; document.getElementById('main-content').innerHTML=renderDesordres(); setTimeout(()=>drawEvolutionChart(id),100); }
function renderDesordres() {
  if (selectedDesordre) {
    const d=DESORDRES.find(x=>x.id===selectedDesordre); if(!d){selectedDesordre=null;return renderDesordres();}
    const ouv=OUVRAGES.find(o=>o.id===d.ouvrage), pct=((d.evolution.at(-1).val/d.evolution[0].val-1)*100).toFixed(0);
    return `<div class="fade-in"><div style="cursor:pointer;color:var(--txt-m);font-size:13px;margin-bottom:20px" onclick="selectedDesordre=null;renderModule()" tabindex="0" role="link" onkeydown="if(event.key==='Enter'){selectedDesordre=null;renderModule()}">â† Retour</div>
      <div class="grid-2">
        <div class="card"><div class="card-title">Fiche dÃ©sordre #${d.id}</div>
          ${[['Ouvrage',ouv?.nom],['Ã‰lÃ©ment',d.element],['Nature',d.type],['SÃ©vÃ©ritÃ©',iqoaBadge(d.severite)],['Date',d.date],['Mesures',d.evolution.length]].map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--brd)"><span class="c-m fs13">${l}</span><span class="fw600 fs13">${v}</span></div>`).join('')}
          <div style="margin-top:16px"><button class="btn btn-pri">ğŸ“ GÃ©nÃ©rer rapport</button></div>
        </div>
        <div class="card"><div class="card-title">ğŸ“ˆ Ã‰volution temporelle</div>
          <svg id="evo-chart" style="width:100%;height:160px"></svg>
          <div style="margin-top:14px;padding:12px;background:${d.severite==='3U'?'var(--err-g)':'var(--acc-g)'};border-radius:8px;border:1px solid ${d.severite==='3U'?'rgba(239,68,68,0.3)':'rgba(245,158,11,0.3)'}">
            <div class="fs12 fw700" style="color:${d.severite==='3U'?'var(--err)':'var(--acc)'}">âš ï¸ ${d.severite==='3U'?'TENDANCE CRITIQUE':'SURVEILLANCE RENFORCÃ‰E'}</div>
            <div class="fs11 c-m">Progression +${pct}% depuis le premier constat.</div>
          </div></div>
      </div></div>`;
  }
  return `<div class="fade-in"><div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">Registre des dÃ©sordres (${DESORDRES.length})</div><button class="btn btn-pri">+ Nouveau dÃ©sordre</button></div>
    <table><thead><tr><th>Ouvrage</th><th>Ã‰lÃ©ment</th><th>Type</th><th>SÃ©vÃ©ritÃ©</th><th>Mesures</th><th></th></tr></thead>
    <tbody>${DESORDRES.map(d=>{const ouv=OUVRAGES.find(o=>o.id===d.ouvrage);return `<tr class="clickable" onclick="viewDesordre(${d.id})"><td class="fs12">${ouv?.nom}</td><td class="fw600">${d.element}</td><td class="c-m">${d.type}</td><td>${iqoaBadge(d.severite)}</td><td class="mono">${d.evolution.length}</td><td class="fs12 c-pri">Voir â†—</td></tr>`;}).join('')}</tbody></table>
  </div></div>`;
}

function drawEvolutionChart(id) {
  const d=DESORDRES.find(x=>x.id===id); if(!d)return;
  const svg=d3.select('#evo-chart'); svg.selectAll('*').remove();
  const rect=document.getElementById('evo-chart')?.getBoundingClientRect();
  const w=rect?.width||340,h=160,m={t:15,r:15,b:30,l:40};
  svg.attr('viewBox',`0 0 ${w} ${h}`);
  const color=d.severite==='3U'?'#EF4444':'#F59E0B', data=d.evolution;
  const x=d3.scalePoint().domain(data.map(d=>d.date)).range([m.l,w-m.r]).padding(0.2);
  const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.val)*1.2]).range([h-m.b,m.t]);
  const line=d3.line().x(d=>x(d.date)).y(d=>y(d.val)).curve(d3.curveMonotoneX);
  const area=d3.area().x(d=>x(d.date)).y0(h-m.b).y1(d=>y(d.val)).curve(d3.curveMonotoneX);
  const grad=svg.append('defs').append('linearGradient').attr('id','ag').attr('x1',0).attr('y1',0).attr('x2',0).attr('y2',1);
  grad.append('stop').attr('offset','0%').attr('stop-color',color).attr('stop-opacity',0.3);
  grad.append('stop').attr('offset','100%').attr('stop-color',color).attr('stop-opacity',0.02);
  svg.append('path').datum(data).attr('d',area).attr('fill','url(#ag)');
  svg.append('path').datum(data).attr('d',line).attr('fill','none').attr('stroke',color).attr('stroke-width',2.5);
  data.forEach(p=>{svg.append('circle').attr('cx',x(p.date)).attr('cy',y(p.val)).attr('r',4).attr('fill','#141D2F').attr('stroke',color).attr('stroke-width',2)});
  svg.append('g').attr('transform',`translate(0,${h-m.b})`).call(d3.axisBottom(x).tickSize(0)).select('.domain').remove();
  svg.append('g').attr('transform',`translate(${m.l},0)`).call(d3.axisLeft(y).ticks(4).tickSize(-(w-m.l-m.r))).call(g=>{g.select('.domain').remove();g.selectAll('.tick line').attr('stroke','#1E2A45').attr('stroke-dasharray','2,3')});
  svg.selectAll('text').attr('fill','#8B9DC3').attr('font-size',10).attr('font-family',"'JetBrains Mono',monospace");
}

// â”€â”€â”€ NORMES â”€â”€â”€
function renderNormes() {
  const orgs=[...new Set(NORMS_DB.map(n=>n.org))];
  const filtered=NORMS_DB.filter(n=>(normsOrg==='all'||n.org===normsOrg)&&(normsSearch===''||(n.title+n.ref+n.org+n.domain).toLowerCase().includes(normsSearch.toLowerCase())));
  return `<div class="fade-in"><div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center" role="search">
    <label for="norms-search" class="sr-only">Rechercher</label>
    <input class="input" id="norms-search" style="max-width:340px" placeholder="ğŸ” Rechercher une norme..." value="${normsSearch}">
    <span class="pill ${normsOrg==='all'?'active':''}" onclick="normsOrg='all';renderModule()" tabindex="0" onkeydown="if(event.key==='Enter'){normsOrg='all';renderModule()}">Tous</span>
    ${orgs.map(o=>`<span class="pill ${normsOrg===o?'active':''}" onclick="normsOrg='${o}';renderModule()" tabindex="0" onkeydown="if(event.key==='Enter'){normsOrg='${o}';renderModule()}">${o}</span>`).join('')}
  </div><div class="card"><div class="card-title">ğŸ“š Base normative (${filtered.length} / ${NORMS_DB.length})</div>
    <table><thead><tr><th>Organisme</th><th>RÃ©fÃ©rence</th><th>Titre</th><th>Domaine</th></tr></thead>
    <tbody>${filtered.map(n=>`<tr class="clickable"><td class="fw700 fs12 c-acc">${n.org}</td><td class="mono fs12 fw600">${n.ref}</td><td>${n.title}</td><td><span class="tag tag-pri">${n.domain}</span></td></tr>`).join('')}</tbody></table>
  </div></div>`;
}
function attachNormsEvents() {
  const el=document.getElementById('norms-search');
  if(el) el.addEventListener('input',e=>{normsSearch=e.target.value;renderModule()});
}

// â”€â”€â”€ DOCUMENTS â”€â”€â”€
function renderDocuments() {
  const types=[{id:"inspection",l:"ğŸ“‹ PVID / Inspection"},{id:"expertise",l:"ğŸ”¬ Expertise"},{id:"memoire",l:"ğŸ“ MÃ©moire technique"},{id:"import",l:"ğŸ“ Import rapports"}];
  let pills=`<div style="display:flex;gap:8px;margin-bottom:20px">${types.map(t=>`<span class="pill ${docType===t.id?'active':''}" onclick="docType='${t.id}';renderModule()">${t.l}</span>`).join('')}</div>`;
  if(docType==='import') return `<div class="fade-in">${pills}<div class="card"><div class="card-title">ğŸ“ Import de rapports existants</div>
    <div class="drop-zone"><div style="font-size:40px;margin-bottom:12px">ğŸ“„</div><div class="fw600">Glissez-dÃ©posez vos rapports ici</div><div class="fs12 c-m">PDF, DOCX, XLSX â€¢ Max 50 Mo</div><button class="btn btn-pri" style="margin-top:16px">ğŸ“¤ Parcourir</button></div>
    <div style="margin-top:20px">${[{n:"PVID_Pontorson_2023-06.pdf",d:"2023-06-15"},{n:"Expertise_Sioule_2024-03.docx",d:"2024-03-20"},{n:"Rapport_LongBien_2024-01.pdf",d:"2024-01-10"}].map(f=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--brd)"><div style="display:flex;align-items:center;gap:10px">ğŸ“„<div><div class="fs13 fw600">${f.n}</div><div class="fs11 c-d">${f.d}</div></div></div><span class="fs12 c-ok">âœ… IntÃ©grÃ©</span></div>`).join('')}</div></div></div>`;
  return `<div class="fade-in">${pills}<div class="card">
    <div class="card-title">${docType==='inspection'?'ğŸ“‹ GÃ©nÃ©rateur PVID':docType==='expertise'?'ğŸ”¬ Expertise':'ğŸ“ MÃ©moire technique'}</div>
    <div class="grid-2">
      <div><label class="fs12 c-m fw600" style="display:block;margin-bottom:6px">Ouvrage</label><select class="input">${OUVRAGES.map(o=>`<option>${o.nom}</option>`).join('')}</select></div>
      <div><label class="fs12 c-m fw600" style="display:block;margin-bottom:6px">Client</label><select class="input">${CLIENTS.map(c=>`<option>${c.icon} ${c.label}</option>`).join('')}</select></div>
      <div><label class="fs12 c-m fw600" style="display:block;margin-bottom:6px">Date</label><input type="date" class="input" value="2026-02-16"></div>
      <div><label class="fs12 c-m fw600" style="display:block;margin-bottom:6px">RÃ©fÃ©rentiel</label><select class="input"><option>ITSEOA + CEREMA (routier)</option><option>IN 1256 + SNCF RÃ©seau (ferroviaire)</option><option>CETU (tunnels)</option></select></div>
    </div>
    <div style="margin-top:20px;display:flex;gap:10px"><button class="btn btn-pri">ğŸ¤– GÃ©nÃ©rer avec l'IA</button><button class="btn btn-ghost">ğŸ“¥ ModÃ¨le vierge</button></div>
  </div></div>`;
}

// â”€â”€â”€ PLANNING â”€â”€â”€
function renderPlanning() {
  const tasks=[{name:"PVID Pont Pontorson",start:0,dur:5,cat:"Inspection",color:"var(--pri)"},{name:"Expertise Viaduc Sioule",start:3,dur:8,cat:"Expertise",color:"var(--acc)"},{name:"Travaux rÃ©paration Pontorson",start:14,dur:25,cat:"Travaux",color:"var(--err)"},{name:"PVID Passerelle Rosny",start:7,dur:4,cat:"Inspection",color:"var(--pri)"},{name:"MÃ©moire AO Ligne 4",start:1,dur:12,cat:"AO",color:"#8B5CF6"},{name:"RÃ©daction rapport Long BiÃªn",start:5,dur:10,cat:"Rapport",color:"var(--ok)"},{name:"ITC Pontorson â€“ travaux voie",start:14,dur:3,cat:"SÃ©curitÃ©",color:"#EC4899"},{name:"Inspection Neufchelles",start:20,dur:6,cat:"Inspection",color:"var(--pri)"}];
  const total=42;
  let pills=`<div style="display:flex;gap:8px;margin-bottom:20px"><span class="pill ${planningView==='gantt'?'active':''}" onclick="planningView='gantt';renderModule()">ğŸ“Š Gantt</span><span class="pill ${planningView==='liste'?'active':''}" onclick="planningView='liste';renderModule()">ğŸ“‹ Liste</span></div>`;
  if(planningView==='liste') return `<div class="fade-in">${pills}<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">ğŸ“… Planning Q1 2026</div><button class="btn btn-pri">+ TÃ¢che</button></div>
    <table><thead><tr><th>TÃ¢che</th><th>CatÃ©gorie</th><th>DÃ©but</th><th>DurÃ©e</th></tr></thead>
    <tbody>${tasks.map(t=>`<tr class="clickable"><td class="fw600">${t.name}</td><td><span class="tag" style="background:${t.color}20;color:${t.color}">${t.cat}</span></td><td class="mono fs12">J+${t.start}</td><td class="mono fs12">${t.dur}j</td></tr>`).join('')}</tbody></table></div></div>`;
  return `<div class="fade-in">${pills}<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title">ğŸ“… Planning Q1 2026</div><button class="btn btn-pri">+ TÃ¢che</button></div>
    <div style="overflow-x:auto"><div style="display:grid;grid-template-columns:220px 1fr;min-width:800px">
      <div style="border-right:1px solid var(--brd)"><div style="height:32px;border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 12px;font-size:11px;color:var(--txt-m);font-weight:700;text-transform:uppercase">TÃ¢che</div>${tasks.map(t=>`<div class="gantt-task">${t.name}</div>`).join('')}</div>
      <div><div class="gantt-header">${['FÃ©v.','Mars','Avr.'].map(m=>`<div class="gantt-month">${m}</div>`).join('')}</div>
        ${tasks.map(t=>`<div class="gantt-row"><div class="gantt-bar" style="left:${(t.start/total)*100}%;width:${(t.dur/total)*100}%;background:${t.color}">${t.cat}</div></div>`).join('')}
      </div></div></div></div></div>`;
}

// â”€â”€â”€ AI ASSISTANT â€” UNIVERSAL PROMPT GENERATOR â”€â”€â”€
function renderAI() {
  const topics = [
    {id:"general",l:"ğŸ’¬ GÃ©nÃ©ral",desc:"Question libre sur les ouvrages d'art"},
    {id:"pvid",l:"ğŸ“‹ RÃ©diger un PVID",desc:"Rapport d'inspection dÃ©taillÃ©e"},
    {id:"expertise",l:"ğŸ”¬ Expertise pathologique",desc:"Analyse de dÃ©sordre"},
    {id:"memoire",l:"ğŸ“ MÃ©moire technique",desc:"RÃ©ponse Ã  appel d'offres"},
    {id:"normes",l:"ğŸ“š Consultation normes",desc:"Question normative"},
    {id:"planning",l:"ğŸ“… Planning travaux",desc:"Phasage et organisation"},
  ];
  return `<div class="fade-in">
    <div class="card" style="border-top:3px solid var(--pri)">
      <div class="card-title">ğŸ¤– GÃ©nÃ©rateur de prompts IA â€” Compatible toutes les IA</div>
      <div class="c-m fs13" style="margin-bottom:16px">SÃ©lectionnez un type de demande, personnalisez, puis copiez le prompt et collez-le dans l'IA de votre choix.</div>
      <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
        ${topics.map(t=>`<span class="pill ${promptTopic===t.id?'active':''}" onclick="promptTopic='${t.id}';renderModule()" tabindex="0" onkeydown="if(event.key==='Enter'){promptTopic='${t.id}';renderModule()}">${t.l}</span>`).join('')}
      </div>
      <div class="grid-2" style="margin-bottom:16px">
        <div><label for="ai-ouvrage" class="fs12 c-m fw600" style="display:block;margin-bottom:6px">Ouvrage concernÃ©</label>
          <select class="input" id="ai-ouvrage"><option value="">â€” Aucun (question gÃ©nÃ©rale) â€”</option>${OUVRAGES.map(o=>`<option value="${o.id}">${o.nom} (${o.iqoa})</option>`).join('')}</select></div>
        <div><label for="ai-detail" class="fs12 c-m fw600" style="display:block;margin-bottom:6px">PrÃ©cisions / question spÃ©cifique</label>
          <input class="input" id="ai-detail" placeholder="Ex: fissure poutre PG, corrosion rivets..."></div>
      </div>
      <button class="btn btn-pri" onclick="generatePrompt()" style="margin-bottom:20px">ğŸ”§ GÃ©nÃ©rer le prompt</button>
      <div id="prompt-output"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸŒ Ouvrir dans votre IA prÃ©fÃ©rÃ©e</div>
      <div class="c-m fs13" style="margin-bottom:12px">AprÃ¨s avoir copiÃ© le prompt, ouvrez l'une de ces IA et collez-le :</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a href="https://copilot.microsoft.com" target="_blank" class="ai-link">ğŸŸ¢ Microsoft Copilot</a>
        <a href="https://chatgpt.com" target="_blank" class="ai-link">ğŸŸ£ ChatGPT</a>
        <a href="https://gemini.google.com" target="_blank" class="ai-link">ğŸ”µ Google Gemini</a>
        <a href="https://claude.ai" target="_blank" class="ai-link">ğŸŸ  Claude (Anthropic)</a>
        <a href="https://chat.mistral.ai" target="_blank" class="ai-link">âšª Mistral Le Chat</a>
        <a href="https://huggingface.co/chat" target="_blank" class="ai-link">ğŸŸ¡ HuggingChat</a>
      </div>
    </div>
  </div>`;
}

function generatePrompt() {
  const ouvId = document.getElementById('ai-ouvrage')?.value;
  const detail = document.getElementById('ai-detail')?.value.trim() || '';
  const ouv = ouvId ? OUVRAGES.find(o=>o.id==ouvId) : null;
  const cl = ouv ? CLIENTS.find(c=>c.id===ouv.client) : null;
  const des = ouv ? DESORDRES.filter(d=>d.ouvrage===ouv.id) : [];

  let contextBlock = '';
  if (ouv) {
    contextBlock = `\n\nCONTEXTE OUVRAGE :\n- Nom : ${ouv.nom}\n- Type : ${ouv.type}\n- Client : ${cl?.label || ''}\n- Cotation IQOA : ${ouv.iqoa}\n- DerniÃ¨re inspection : ${ouv.lastInsp}\n- Nombre d'avaries : ${ouv.avaries}\n- Normes applicables : ${cl?.norms.join(', ')}`;
    if (des.length) {
      contextBlock += '\n\nDÃ‰SORDRES ACTIFS :';
      des.forEach(d => {
        const lastVal = d.evolution.at(-1);
        contextBlock += `\n- ${d.element} : ${d.type} (sÃ©vÃ©ritÃ© ${d.severite}, derniÃ¨re mesure : ${lastVal.val}, date : ${lastVal.date})`;
      });
    }
  }

  let taskBlock = '';
  switch(promptTopic) {
    case 'pvid':
      taskBlock = `\n\nMISSION : RÃ©dige un ProcÃ¨s-Verbal d'Inspection DÃ©taillÃ©e (PVID) conforme ${cl?.norms.includes('SNCF RÃ©seau')?'Ã  l\'IN 1256 SNCF RÃ©seau':'Ã  l\'ITSEOA et au guide IQOA du CEREMA'}. Structure le rapport avec : identification de l'ouvrage, conditions d'inspection, description gÃ©nÃ©rale, relevÃ© dÃ©taillÃ© des dÃ©sordres avec cotation, synthÃ¨se et prÃ©conisations, annexes photos.`;
      break;
    case 'expertise':
      taskBlock = `\n\nMISSION : RÃ©alise une expertise pathologique${detail?' portant sur : '+detail:''}. Inclus : description du dÃ©sordre, analyse des causes probables (fatigue, corrosion, surcharge, dÃ©faut d'exÃ©cution...), Ã©valuation de la sÃ©vÃ©ritÃ©, Ã©volution prÃ©visible, prÃ©conisations de rÃ©paration avec rÃ©fÃ©rences normatives (STRRES RECO NÂ°4, guides CEREMA, ${cl?.norms.join(', ')||'normes applicables'}).`;
      break;
    case 'memoire':
      taskBlock = `\n\nMISSION : RÃ©dige un mÃ©moire technique pour un appel d'offres${detail?' : '+detail:''}. Structure : 1) PrÃ©sentation de l'entreprise et rÃ©fÃ©rences, 2) ComprÃ©hension de la mission, 3) MÃ©thodologie d'intervention dÃ©taillÃ©e, 4) Moyens humains et matÃ©riels, 5) Planning prÃ©visionnel (Gantt), 6) PPSPS / sÃ©curitÃ©, 7) PAQ / dÃ©marche qualitÃ©, 8) RÃ©fÃ©rences normatives applicables.`;
      break;
    case 'normes':
      taskBlock = `\n\nMISSION : RÃ©ponds Ã  la question normative suivante : ${detail||'Quelles normes sont applicables pour cet ouvrage ?'}. Cite prÃ©cisÃ©ment les rÃ©fÃ©rences (fascicule, article, paragraphe) parmi : ITSEOA, CEREMA, SNCF RÃ©seau (IN 1256, IN 1260, IN 7012/00035, IN 00036), SETRA, LCPC, Eurocodes, CCTG, ISO 12944.`;
      break;
    case 'planning':
      taskBlock = `\n\nMISSION : Ã‰labore un planning de travaux${detail?' pour : '+detail:''}. Inclus le phasage (Ã©tudes, prÃ©paration, travaux, rÃ©ception), les contraintes d'exploitation ${cl?.norms.includes('SNCF RÃ©seau')?'ferroviaire (ITC, ralentissements, fenÃªtres de travaux)':'(basculements de circulation, dÃ©viations)'}, les jalons clÃ©s, et une estimation des durÃ©es. Format Gantt si possible.`;
      break;
    default:
      taskBlock = detail ? `\n\nQUESTION : ${detail}` : '\n\nQUESTION : [Posez votre question ici]';
  }

  const fullPrompt = AI_SYSTEM_PROMPT + contextBlock + taskBlock;

  document.getElementById('prompt-output').innerHTML = `
    <div style="position:relative">
      <div class="prompt-box" id="prompt-text">${escapeHtml(fullPrompt)}</div>
      <div class="prompt-actions">
        <button class="copy-btn" onclick="copyPrompt()">ğŸ“‹ Copier le prompt</button>
        <span id="copy-status" class="fs12 c-m"></span>
      </div>
    </div>`;
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function copyPrompt() {
  const text = document.getElementById('prompt-text')?.innerText;
  if (!text) return;
  navigator.clipboard.writeText(text).then(()=>{
    const btn = document.querySelector('.copy-btn');
    const status = document.getElementById('copy-status');
    if (btn) { btn.classList.add('copied'); btn.textContent = 'âœ… CopiÃ© !'; }
    if (status) status.textContent = 'Collez-le maintenant dans Copilot, ChatGPT, Gemini, Claude...';
    setTimeout(()=>{ if(btn){btn.classList.remove('copied');btn.textContent='ğŸ“‹ Copier le prompt';} },3000);
  });
}

// â”€â”€â”€ SHAREPOINT â”€â”€â”€
function renderSharepoint() {
  return `<div class="fade-in"><div class="card"><div class="card-title">â˜ï¸ IntÃ©gration SharePoint</div>
    <div class="grid-2" style="margin-bottom:20px">
      <div><label class="fs12 c-m fw600" style="display:block;margin-bottom:6px">URL du site SharePoint</label><input class="input" placeholder="https://votreentreprise.sharepoint.com/sites/OA"></div>
      <div><label class="fs12 c-m fw600" style="display:block;margin-bottom:6px">BibliothÃ¨que de documents</label><input class="input" placeholder="Documents partagÃ©s / OA / Rapports"></div>
    </div>
    <div style="display:flex;gap:10px"><button class="btn btn-pri">ğŸ”— Connecter</button><button class="btn btn-ghost">ğŸ”„ Synchroniser</button></div>
  </div>
  <div class="grid-2">
    <div class="card"><div class="card-title">ğŸ“¤ Publication automatique</div>
      ${[{l:"PVID et rapports d'inspection",p:"/Sites/OA/Inspections/",on:true},{l:"MÃ©moires techniques",p:"/Sites/OA/AO/MÃ©moires/",on:true},{l:"Photos et relevÃ©s",p:"/Sites/OA/MÃ©dias/",on:false},{l:"Plannings",p:"/Sites/OA/Planning/",on:true}
      ].map(r=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--brd)"><div><div class="fs13 fw600">${r.l}</div><div class="fs11 c-d mono">${r.p}</div></div><div class="toggle ${r.on?'on':'off'}" style="cursor:pointer"><div class="toggle-knob"></div></div></div>`).join('')}
    </div>
    <div class="card"><div class="card-title">ğŸ“¥ DerniÃ¨res synchros</div>
      ${[{f:"PVID_Pontorson_2025-11.docx",t:"Il y a 2h",s:"âœ…",u:"D. Lhote"},{f:"Planning_Q1_2026.xlsx",t:"Il y a 5h",s:"âœ…",u:"D. Lhote"},{f:"Photos_Sioule_lot3.zip",t:"Hier",s:"â³",u:"L. Aurier"},{f:"Memoire_AO_Ligne4.docx",t:"14/02",s:"âœ…",u:"D. Lhote"}
      ].map(s=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--brd)"><div style="display:flex;align-items:center;gap:8px">${s.s}<div><div class="fs13 fw600">${s.f}</div><div class="fs11 c-d">${s.u} â€¢ ${s.t}</div></div></div></div>`).join('')}
    </div>
  </div></div>`;
}

// â”€â”€â”€ COLLABORATION â”€â”€â”€
function renderCollab() {
  const team = [
    {n:"Damien LHOTE",i:"DL",p:"Chef de projet OA",c:"#3B82F6",on:true},
    {n:"Louis AURIER",i:"LA",p:"Inspecteur OA",c:"#10B981",on:true},
    {n:"Hamza OUABDEL MOUMEN",i:"HO",p:"Inspecteur OA",c:"#8B5CF6",on:false},
    {n:"Dalila SEGMANE",i:"DS",p:"Inspecteur OA",c:"#EC4899",on:true},
  ];
  return `<div class="fade-in"><div class="card"><div class="card-title">ğŸ‘¥ Ã‰quipe projet</div>
    <div class="grid-4">${team.map(u=>`<div style="padding:16px;background:var(--bg);border-radius:10px;border:1px solid var(--brd);display:flex;align-items:center;gap:14px">
      <div style="width:44px;height:44px;border-radius:22px;background:${u.c};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;color:#fff;position:relative">${u.i}<div style="width:10px;height:10px;border-radius:5px;background:${u.on?'var(--ok)':'var(--txt-d)'};position:absolute;bottom:0;right:0;border:2px solid var(--bg)"></div></div>
      <div><div class="fw700" style="font-size:14px">${u.n}</div><div class="fs12 c-m">${u.p}</div></div>
    </div>`).join('')}</div>
  </div>
  <div class="grid-2">
    <div class="card"><div class="card-title">ğŸ’¬ ActivitÃ©</div>
      ${[{u:"DL",m:"PVID Pontorson finalisÃ© et publiÃ© sur SharePoint",t:"14:30",c:"#3B82F6"},{u:"LA",m:"Ajout de 3 photos sur le dÃ©sordre #2 (Sioule)",t:"11:15",c:"#10B981"},{u:"DL",m:"Nouvelle cotation 3U sur fissure poutre PG Pontorson",t:"09:45",c:"#3B82F6"},{u:"DS",m:"Rapport inspection Rosny â€“ version finale",t:"Hier",c:"#EC4899"}
      ].map(a=>`<div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--brd)"><div style="width:32px;height:32px;border-radius:16px;background:${a.c};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:#fff;flex-shrink:0">${a.u}</div><div><div class="fs13">${a.m}</div><div class="fs11 c-d">${a.t}</div></div></div>`).join('')}
    </div>
    <div class="card"><div class="card-title">ğŸ”” Notifications</div>
      ${[{i:"âš ï¸",m:"DÃ©sordre 3U â€“ Pontorson : intervention requise sous 2 semaines",p:"urgent"},{i:"ğŸ“…",m:"Rappel : COTECH Long BiÃªn le 03/03 Ã  14h",p:"normal"},{i:"ğŸ“‹",m:"Rapport expertise Sioule en attente de validation",p:"normal"},{i:"ğŸ”„",m:"Sync SharePoint terminÃ©e (4 fichiers)",p:"info"}
      ].map(n=>`<div style="display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--brd)"><span style="font-size:16px">${n.i}</span><div class="fs13 ${n.p==='urgent'?'fw700 c-err':''}">${n.m}</div></div>`).join('')}
    </div>
  </div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildSidebar();
navigate('dashboard');
</script>
</body>
</html>
